# Task ID: 4
# Title: Supabase Data Access and Validation Layer
# Status: done
# Dependencies: 2, 3
# Priority: high
# Description: Build shared Supabase data-access helpers and validation utilities for direct client-side CRUD operations.
# Details:
Replace Nitro server routes with typed Supabase client modules that run entirely in the static Nuxt app. Implement consistent error handling, optimistic updates, and RLS-aware patterns so all CRUD flows talk directly to Supabase. Create reusable validation logic that mirrors database constraints and supports form usage across the dashboard.

# Test Strategy:
Exercise Supabase client helpers against a seeded project to verify CRUD, optimistic updates, and error cases. Run integration tests in the browser to confirm RLS prevents cross-user access and validation rejects invalid payloads. Simulate network failures to ensure retry and rollback behaviour works without a custom server.

# Subtasks:
## 1. Create Supabase data access modules [pending]
### Dependencies: None
### Description: Establish typed helper modules for interacting with Supabase tables and RPC endpoints from the client.
### Details:
Build lib/supabase/projects.ts and lib/supabase/stints.ts modules that wrap the Supabase JS client with the existing Database types. Expose CRUD helpers (list, create, update, delete) that automatically scope queries by auth.uid() and include standard error handling via utils/supabase.ts. Document how each helper should be consumed by composables and components.
<info added on 2025-09-28T05:11:01.890Z>
Looking at the project structure and existing codebase to understand the current implementation and inform the enhanced approach...
</info added on 2025-09-28T05:11:01.890Z>

## 2. Define shared Zod schemas for Supabase payloads [pending]
### Dependencies: 4.1
### Description: Create client-side validation schemas that mirror database constraints for projects and stints.
### Details:
Add schemas/projects.ts and schemas/stints.ts using Zod to validate create/update payloads before sending them to Supabase. Share schemas with form components and data helpers so validation logic stays consistent. Include refinement rules for stint duration limits, single-active requirements, and note length constraints.

## 3. Implement project CRUD helpers with optimistic UI patterns [pending]
### Dependencies: 4.1, 4.2
### Description: Use Supabase client helpers to power project creation, updates, activation toggles, and deletion without a custom API.
### Details:
Extend lib/supabase/projects.ts with optimistic mutation helpers that update local state immediately and roll back on failure. Ensure helpers respect RLS, pass validation results back to callers, and support multi-tab updates via existing Supabase realtime integrations.

## 4. Implement stint lifecycle helpers with single-active enforcement [pending]
### Dependencies: 4.1, 4.2
### Description: Create Supabase-driven start/stop/pause flows that guarantee only one active stint per user.
### Details:
Add startStint, stopStint, pauseStint, and resumeStint helpers that coordinate with Supabase RPC or transactional SQL functions to enforce the single-active constraint. Update helpers to derive authoritative timing from Supabase (planned vs actual duration) and to record completion types in line with the PRD.
<info added on 2025-09-28T05:11:59.850Z>
I'll analyze the codebase to understand the current implementation and provide specific recommendations based on the project structure.
</info added on 2025-09-28T05:11:59.850Z>

## 5. Add client-side caching, retry, and error surfacing [pending]
### Dependencies: 4.3, 4.4
### Description: Harden Supabase interactions with caching, retry rules, and consistent error messaging.
### Details:
Integrate Nuxt query caching (e.g., useAsyncData or Vue Query) around Supabase calls to coalesce requests and provide stale-while-revalidate behaviour. Implement retry logic for transient Supabase errors and emit structured error objects for UI consumption. Create toast/notification patterns for failures so users understand when Supabase rejects an operation.

## 6. Implement offline-first capabilities with sync [pending]
### Dependencies: 4.3, 4.4, 4.5
### Description: Add local storage queuing for offline mutations and conflict resolution
### Details:
Create composables/useOfflineSupport.ts with local storage mutation queue, auto-sync when connection restored, and conflict resolution for offline changes. Implement connection state monitoring, offline indicator UI, and graceful handling of network failures during active stints. Include retry mechanisms and data consistency checks for synchronized operations.

