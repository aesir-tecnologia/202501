# Task ID: 2
# Title: Database Schema and RLS Policies
# Status: done
# Dependencies: 1
# Priority: high
# Description: Design and implement PostgreSQL database schema with Row Level Security
# Details:
Create users, projects, and stints tables using Supabase SQL editor. Implement RLS policies for data isolation per user. Set up foreign key relationships and constraints. Create indexes for performance optimization. Add triggers for updated_at timestamps. Use UUID primary keys for security. Create database types file for TypeScript integration.

# Test Strategy:
Test RLS policies prevent cross-user data access, verify foreign key constraints work, validate indexes improve query performance, test all CRUD operations respect security policies.

# Subtasks:
## 1. Create database schema with tables (users, projects, stints) [done]
### Dependencies: None
### Description: Design and create the core database tables using Supabase SQL editor
### Details:
Create users table with id (uuid primary key), email (unique text), created_at, updated_at, and auth integration fields. Create projects table with id (uuid primary key), user_id (foreign key), name (text), expected_daily_stints (integer, default 2), custom_stint_duration (integer nullable), is_active (boolean default true), created_at, updated_at. Create stints table with id (uuid primary key), project_id (foreign key), user_id (foreign key), started_at (timestamp), ended_at (timestamp nullable), duration_minutes (integer), notes (text nullable), is_completed (boolean default false), created_at, updated_at. Use UUID primary keys for security and set up proper foreign key constraints between tables.

## 2. Implement Row Level Security (RLS) policies [done]
### Dependencies: 2.1
### Description: Set up RLS policies to ensure users can only access their own data
### Details:
Enable RLS on all three tables (users, projects, stints). Create policies for users table: users can only read/update their own profile based on auth.uid(). Create policies for projects table: users can only CRUD their own projects where user_id = auth.uid(). Create policies for stints table: users can only CRUD stints for their own projects through a join with projects table. Test that users cannot access other users' data through any query method. Add policies for INSERT, SELECT, UPDATE, DELETE operations on each table.

## 3. Set up database indexes for performance optimization [done]
### Dependencies: 2.1
### Description: Create indexes on frequently queried columns to improve performance
### Details:
Create index on users.email for authentication lookups. Create index on projects.user_id for user-specific project queries. Create composite index on (projects.user_id, projects.is_active) for active project filtering. Create index on stints.project_id for stint queries by project. Create composite index on (stints.user_id, stints.started_at) for user timeline queries. Create index on stints.started_at for date-based filtering and ordering. Consider partial indexes for active stints (where ended_at IS NULL) to optimize real-time queries.

## 4. Add database triggers for updated_at timestamps [done]
### Dependencies: 2.1
### Description: Create triggers to automatically update the updated_at column on record changes
### Details:
Create a reusable trigger function update_updated_at_column() that sets NEW.updated_at = NOW() when any row is updated. Apply this trigger to all three tables (users, projects, stints) so that updated_at is automatically maintained without requiring application-level logic. Test that the triggers fire correctly on UPDATE operations but not on INSERT operations. Ensure triggers work with RLS policies enabled.

## 5. Generate TypeScript database types file [done]
### Dependencies: 2.1, 2.2, 2.3, 2.4
### Description: Create TypeScript interfaces for type-safe database operations
### Details:
Use Supabase CLI to generate TypeScript types: 'supabase gen types typescript --project-id=PROJECT_ID > types/database.ts'. Create types directory if it doesn't exist. Generate complete type definitions for all tables, views, and functions. Set up proper imports and exports for use throughout the Nuxt application. Create utility types for common operations like InsertPayload, UpdatePayload, and SelectResult for each table. Ensure types include proper nullable field handling and foreign key relationships.

## 6. Add tests for Row Level Security policies [done]
### Dependencies: None
### Description: Implement comprehensive test coverage for RLS policies including policy enforcement (users can only access their own data), performance optimization (the recent RLS performance fix migration), and cross-table policy validation (stints-projects relationship)
### Details:


## 7. Add tests for utility functions [done]
### Dependencies: None
### Description: Implement comprehensive test coverage for 248 lines in utils/supabase.ts including authentication functions (signInWithEmail, signUpWithEmail, etc.), database query helpers (safeQuery, paginatedQuery), file upload/storage functions, error handling and response wrapping, and real-time subscription helpers
### Details:


