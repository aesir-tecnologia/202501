# LifeStint - Product Overview & Strategy

**Product Name:** LifeStint  
**Tagline:** Small sprints. Big results.  
**Document Version:** 3.0  
**Date:** October 24, 2025  
**Status:** Ready for Development

---

## Executive Summary

LifeStint is a productivity tracking application that helps busy professionals maintain focus across multiple projects through a "stint-based" approachâ€”predetermined focused work sessions with single-session enforcement to prevent multitasking.

**The Core Innovation:** Unlike traditional time trackers that log work retroactively or Pomodoro apps that ignore project context, LifeStint combines project-level focus tracking with professional reporting capabilities while maintaining zero administrative overhead.

**Key Value Propositions:**
- **Zero Administrative Overhead:** One-click start/stop without categories, tags, or setup friction
- **Single Active Focus:** Technical enforcement prevents multitasking and context switching
- **Professional Analytics:** Client-ready reports demonstrating focus quality without surveillance
- **Habit Building:** Progress visualization and streak tracking motivate consistent productive work

**Target Market:** Independent professionalsâ€”freelancers, consultants, and remote workers managing 2-6 active projects who need to justify billing rates and demonstrate productivity to clients.

**Business Model:** Freemium SaaS with free tier (2 projects, basic analytics) and Pro tier ($12/month for unlimited projects, advanced analytics, and custom branding on exports).

---

## Problem Statement

### The Core Problem

Knowledge workers, particularly independent professionals, struggle with three interconnected challenges:

1. **Focus Fragmentation:** Managing 3-6 concurrent projects creates constant context switching, with each switch costing 15-25 minutes of productive time
2. **Productivity Opacity:** Clients equate "few meetings" with "no work," forcing professionals to defend their value
3. **Tool Inadequacy:** Existing solutions either micromanage (detailed time tracking) or oversimplify (basic Pomodoro timers)

### Impact Quantification

- Average consultant loses 2.1 hours daily to context switching (RescueTime 2024 study)
- 67% of independent consultants report client skepticism about remote work productivity
- Time tracking tools add 15-20 minutes of daily administrative overhead (Toggl user surveys)

### Current Solutions Fall Short

**Time Trackers (Toggl, Harvest):**
- Administrative burden of categorizing every work session
- Surveillance-oriented reporting that damages client trust
- No focus quality measurement

**Pomodoro Apps (Forest, Focus Keeper):**
- Generic 25-minute sessions ignore project needs
- No project-level progress tracking
- No professional reporting capabilities

**Project Management (Asana, Trello):**
- Task completion focus, not work quality
- No time/focus tracking integration
- Overhead of maintaining task hierarchies

### The Gap LifeStint Fills

A tool that tracks **project-level focus sessions** with **professional reporting** while maintaining **zero administrative overhead**.

---

## Solution Overview

### Core Concept: The Stint

A **stint** is a predetermined focused work session (default 120 minutes, customizable per project) where:
- User commits to single-project focus
- Timer runs with pause/resume capability
- System enforces single active stint across all devices
- Completion is tracked with precise timing

### How It Works

1. **Setup:** Create projects with expected daily stints (default: 2 per day)
2. **Execute:** Start stint from dashboard, work with timer running, stop manually or auto-complete
3. **Track:** View daily progress, maintain streaks, export professional reports
4. **Demonstrate:** Share focus ledger (CSV export) with clients showing consistent work quality

### Key Differentiators

- **Project-Aware Focus:** Unlike Pomodoro apps, stints understand project context
- **Single Active Session:** Technical enforcement prevents multitasking
- **Professional Reporting:** Client-ready exports without surveillance metrics
- **Zero Overhead:** No categories, tags, or pre-work required
- **Cross-Device Real-Time:** Seamless sync with conflict resolution

---

## Competitive Analysis

### Market Landscape

**Category:** Productivity & Time Tracking  
**Market Size:** $10B globally (2024), growing 15% YoY  
**Trends:** Remote work permanence, focus on deep work, distrust of surveillance tools

### Direct Competitors

**1. Toggl Track**
- **Strengths:**
  - Mature product (14+ years)
  - Team features (timesheets, reporting)
  - Integrations (100+ apps)
  - Mobile apps
- **Weaknesses:**
  - Billing/client focus (not personal productivity)
  - Requires categorization (high friction)
  - Surveillance perception
  - Expensive for individuals ($9-18/user/month)
- **Differentiation:** LifeStint focuses on focus quality over billing hours, zero categorization overhead, and professional reporting without surveillance metrics.

**2. Harvest**
- **Strengths:**
  - Strong invoicing integration
  - Team collaboration
  - Expense tracking
  - Professional branding
- **Weaknesses:**
  - Expensive ($12/user/month)
  - Overkill for solo consultants
  - Complicated setup
  - Billing-centric (not productivity-centric)
- **Differentiation:** LifeStint is simpler, cheaper, and focuses on demonstrating work quality rather than tracking billable hours.

**3. RescueTime**
- **Strengths:**
  - Automatic tracking (no manual start/stop)
  - Detailed app/website tracking
  - Productivity scoring
- **Weaknesses:**
  - Passive tracking (no active commitment)
  - Privacy concerns (monitors all activity)
  - No project-level organization
  - Expensive ($12/month)
- **Differentiation:** LifeStint is intentional (active stints, not passive tracking), project-aware, and privacy-focused (only tracks what you start).

### Indirect Competitors

**4. Forest / Focus Keeper (Pomodoro Apps)**
- **Strengths:**
  - Simple, beautiful UI
  - Gamification (grow trees)
  - Low cost ($2-5 one-time)
- **Weaknesses:**
  - Generic 25-minute sessions (inflexible)
  - No project tracking
  - No professional reporting
  - Mobile-only (Forest)
- **Differentiation:** LifeStint is project-aware, customizable durations, and offers professional exports.

**5. Notion / Asana (Project Management)**
- **Strengths:**
  - Full project management
  - Collaboration features
  - Free tiers
- **Weaknesses:**
  - No focus time tracking
  - High overhead (tasks, subtasks, statuses)
  - Not designed for focus sessions
- **Differentiation:** LifeStint integrates focus tracking into project management, not separate tools.

**6. Clockify (Free Time Tracker)**
- **Strengths:**
  - Completely free (unlimited users)
  - Team features
  - Reporting
- **Weaknesses:**
  - Billing focus (like Toggl)
  - Requires categorization
  - UI feels dated
  - No focus-quality metrics
- **Differentiation:** LifeStint is focus-quality first, professional reporting, and modern UI.

### Competitive Positioning

**LifeStint's Unique Position:**
- **Target:** Independent consultants (not enterprises)
- **Focus:** Work quality demonstration (not billing compliance)
- **Approach:** Intentional stints (not passive surveillance)
- **Friction:** Zero overhead (not detailed categorization)

**Value Propositions Competitors Can't Match:**
1. **Single Active Stint Enforcement:** Technically prevents multitasking (competitors allow concurrent timers)
2. **Professional Focus Ledger:** CSV export emphasizes focus consistency without surveillance (competitors show "productivity scores")
3. **Project-Aware Streaks:** Tracks consistency across projects (Pomodoro apps are project-agnostic)
4. **Zero Setup:** Start tracking in <60 seconds (competitors require project setup, categories, billing rates)

### Pricing Comparison

| Product | Free Tier | Paid Tier | Notes |
|---------|-----------|-----------|-------|
| **LifeStint** | 2 projects, 90-day history | $12/month (unlimited) | Focus on individuals |
| Toggl Track | 5 users, basic reports | $9-18/user/month | Team-focused pricing |
| Harvest | 1 user, 2 projects | $12/user/month | No free tier for teams |
| RescueTime | Limited features | $12/month | No free tier |
| Clockify | Unlimited users | $5-10/user/month (optional) | Free tier is generous |
| Forest | N/A | $2 one-time (mobile) | Not subscription |

**LifeStint's Pricing Strategy:**
- **Free Tier:** Generous enough for casual users (2 projects covers most)
- **Pro Tier:** $12/month competitive with RescueTime/Harvest, higher than Toggl but more value for individuals
- **No Team Pricing:** MVP focuses on individuals (teams later)

---

## Market Opportunity

### Addressable Market

- **TAM (Total Addressable Market):** 50M+ independent professionals globally
- **SAM (Serviceable Addressable Market):** 10M+ consultants/freelancers in US/EU who bill clients
- **SOM (Serviceable Obtainable Market):** 50K users (0.5% of SAM) in first 2 years

### Unit Economics (Projected)

- **Average Revenue Per User (ARPU):** $10/month (assumes 40% on free tier, 60% on Pro)
- **Customer Acquisition Cost (CAC):** $30 (organic + referrals)
- **Lifetime Value (LTV):** $240 (24-month avg retention)
- **LTV:CAC Ratio:** 8:1 (healthy)

### Go-to-Market Strategy

1. **Private Beta:** 100 consultants via warm intros (months 1-2)
2. **Product Hunt Launch:** Drive 1K signups (month 3)
3. **Content Marketing:** Focus techniques, remote work productivity (months 4-6)
4. **Partnerships:** List on consultant directories, freelance platforms (months 7-12)
5. **Referral Program:** Existing users invite friends (ongoing)

---

## Business Model

### Freemium SaaS Structure

**Free Tier:**
- 2 active projects
- 90-day analytics history
- Basic CSV exports (10 per month)
- Standard support

**Pro Tier ($12/month):**
- Unlimited projects
- Unlimited analytics history
- Unlimited CSV exports
- Custom branding on exports
- Priority support
- Advanced analytics features

### Revenue Projections (Year 1)

- **Month 3:** 1,000 users (600 free, 400 Pro) = $4,800 MRR
- **Month 6:** 5,000 users (3,000 free, 2,000 Pro) = $24,000 MRR
- **Month 12:** 15,000 users (9,000 free, 6,000 Pro) = $72,000 MRR

### Key Assumptions

- 40% free tier, 60% Pro conversion (optimistic but achievable)
- 5% monthly churn rate
- $30 CAC (organic + referrals)
- 24-month average customer lifetime

---

## Key Value Propositions

### For Independent Consultants

1. **Demonstrate Work Quality:** CSV exports show consistent focus without surveillance metrics
2. **Reduce Context Switching:** Single active stint enforcement prevents multitasking
3. **Zero Friction:** Start tracking in <60 seconds, no setup overhead
4. **Build Habits:** Streak tracking and progress visualization motivate consistency

### For Remote Workers

1. **Justify Productivity:** Show clients evidence of focused work
2. **Maintain Boundaries:** Clear session structure separates work from life
3. **Cross-Device Sync:** Seamless experience across desktop, tablet, phone
4. **Professional Reports:** Client-ready exports without technical jargon

### For Freelancers

1. **Defend Rates:** Demonstrate focus quality to justify premium pricing
2. **Track Multiple Projects:** Manage 3-6 concurrent projects without confusion
3. **Minimal Overhead:** No time wasted on categorization or setup
4. **Build Credibility:** Consistent work patterns build client trust

---

## Success Criteria

### Product-Market Fit Indicators

- **7-day retention:** >40%
- **30-day retention:** >25%
- **Average stints per user per week:** >5
- **CSV export usage:** >20% of active users monthly
- **NPS (Net Promoter Score):** >40

### Business Metrics

- **Free to Pro conversion:** >5%
- **Monthly churn rate:** <10%
- **Customer lifetime value:** >$200
- **LTV:CAC ratio:** >5:1

---

**Related Documents:**
- [02-user-personas-flows.md](./02-user-personas-flows.md) - Detailed user personas and flows
- [03-feature-requirements.md](./03-feature-requirements.md) - Complete feature specifications
- [08-success-metrics.md](./08-success-metrics.md) - Detailed success metrics and KPIs

# LifeStint - User Personas & Experience Flows

**Product Name:** LifeStint  
**Document Version:** 3.0  
**Date:** October 24, 2025

---

## Target Audience

### Primary Persona: Sarah the Client-Billable Consultant

**Demographics:**
- Age: 28-35
- Role: Independent software/tech consultant
- Location: Remote/hybrid, urban areas
- Income: $80-150K annually from consulting

**Context:**
- Manages 3-6 concurrent client projects
- Bills by retainer or time-and-materials
- Works from home office or coworking spaces
- Uses MacBook Pro + iPhone/iPad

**Goals:**
- Show consistent focus to clients without surveillance
- Defend premium rates with credible work evidence
- Reduce context switching to improve output quality
- Maintain work-life boundaries with clear session structure

**Pain Points:**
- Clients equate "few meetings" with "no work"
- Timesheets feel accusatory and damage trust
- Context switching destroys momentum and creativity
- No credible way to demonstrate focus quality
- Pomodoro timers don't account for project needs

**Behaviors:**
- Checks phone during work (breaks focus unintentionally)
- Struggles to say "no" to interruptions
- Feels guilty about billing hours without "proof"
- Uses 2-3 productivity apps, none work well together

### Secondary Persona: Marcus the Agency Remote Worker

**Demographics:**
- Age: 25-32
- Role: Designer/developer at distributed agency
- Reports to remote manager with minimal oversight

**Unique Needs:**
- Demonstrate productivity to manager without micromanagement
- Track billable vs. non-billable work
- Build portfolio of focused work for performance reviews

### Out of Scope (for MVP)

- Enterprise teams needing shared dashboards
- Students seeking study session tracking
- Professionals tracking non-knowledge work (e.g., manufacturing)

---

## Onboarding Flow

### Step 1: Registration

- Land on marketing page with "Start Free" CTA
- Registration modal: Email, password, confirm password
- Agree to Terms and Privacy Policy (checkboxes)
- Submit â†’ Email verification notice

### Step 2: Email Verification

- Check inbox for verification email
- Click verification link â†’ Redirects to dashboard
- Welcome modal appears

### Step 3: Welcome Modal

- Slide 1: "Welcome to LifeStint! Let's get you started."
- Slide 2: Animated explanation of stints (30-second Lottie animation)
  - "A stint is a focused work session on one project"
  - "Choose your duration, start your timer, stay focused"
  - "Track progress, build streaks, demonstrate your work"
- Slide 3: "Create your first project"
  - Embedded project creation form (same as normal modal)
  - Pre-filled example: "Client Website Redesign"
  - User can edit or keep example
- Slide 4: "Start your first stint"
  - Shows new project card with pulsing "Start" button
  - User clicks Start â†’ Begins 120-minute stint
  - Modal: "Great! Now focus for 120 minutes. We'll notify you when done."
- Slide 5: "You're all set!"
  - Quick tips:
    - "Pause if you need a break"
    - "Stop early if you finish your task"
    - "Check Analytics to see your progress"
  - "Got it!" button closes modal

### Guided First Stint

- If user stops before 10 minutes: Tooltip "Stints work best with at least 10 minutes of focus"
- At 60 minutes: Encouraging notification "Halfway there! Keep going ðŸ’ª"
- At completion: Celebration animation with confetti
- Modal: "Congrats on your first stint! ðŸŽ‰"
  - Shows summary: Project, duration, time
  - "View Analytics" button â†’ Analytics page
  - "Start Another Stint" button â†’ Dashboard

### Dashboard Tour (Optional, Skippable)

- Tooltips highlight:
  1. Project cards: "Your projects live here"
  2. Progress badges: "Track daily goals"
  3. Active stint: "Only one stint at a time"
  4. "+ New Project" button: "Add more projects anytime"
  5. Analytics link: "View your progress and export reports"
- "Skip Tour" always visible

### Empty State After Onboarding

- If user doesn't create project during onboarding: Shows empty state with "+ New Project" CTA

---

## Daily Usage Flow

### Morning Routine

1. Open LifeStint (web app or PWA)
2. Dashboard loads with today's progress (all at 0 if new day)
3. Review project cards, decide which to work on first
4. Click "Start" on chosen project
5. Begin work with timer running in corner

### During Stint

- Timer visible in browser tab title: "(42:15) LifeStint - [Project Name]"
- Can switch browser tabs, timer continues
- If need break: Click "Pause", do break, click "Resume"
- If task completed early: Click "Stop", optionally add notes

### End of Stint

- Auto-complete: Browser notification + dashboard updates
- Manual stop: Notes modal (optional) â†’ Dashboard updates
- Celebration if daily goal reached: Confetti animation + sound effect (can disable in settings)
- Progress badge updates: "2 of 2 stints today âœ“"

### Afternoon Routine

- Switch to different project
- Repeat start â†’ work â†’ complete cycle
- Check progress badges throughout day

### Evening Wrap-Up

- Review dashboard to see completed stints
- Check streaks: "ðŸ”¥ 5 day streak maintained!"
- Optional: Export CSV for client update

---

## Weekly Review Flow

### Sunday Evening (Typical Use)

1. Click "Analytics" in navigation
2. Review weekly summary:
   - Total stints: 14 (down from last week's 18)
   - Total focus time: 11.5 hours
   - Longest streak: 5 days
3. Observe bar chart showing daily pattern:
   - Notice: Wednesday had only 1 stint (identify improvement area)
4. Review project breakdown:
   - Client A: 6 stints (on track)
   - Client B: 4 stints (below expected 6)
   - Personal Project: 4 stints (unexpected, good!)
5. Click "Export CSV" â†’ Select "Last 7 days"
6. Download Focus Ledger
7. Optional: Attach to weekly client update email with message: "Here's my focus time for the week"
8. Review project expectations:
   - Edit Client B: Increase daily stints from 2 to 3
   - Deactivate completed Personal Project

### Insight Gained

- Wednesday disruption identified â†’ Schedule protected focus time
- Client B needs more attention â†’ Adjust schedule
- Personal project making unexpected progress â†’ Celebrate!

---

## Multi-Device Experience

### Scenario: Start on Desktop, Continue on Mobile

1. **Desktop (9 AM):** Start stint on "Client Website" project â†’ 120-minute timer begins
2. **Leave desk (9:30 AM):** Close laptop (timer continues via server)
3. **Open phone (9:35 AM):** LifeStint PWA loads
   - Real-time sync: Dashboard shows "Client Website" stint active
   - Timer shows 15:00 remaining (accurate despite device switch)
   - Can pause/resume/stop from phone
4. **Return to desk (9:50 AM):** Open laptop
   - Real-time sync: Shows stint ended at 10:00 AM (auto-completed on server)
   - Dashboard updated with completed stint

### Conflict Resolution

- If network was offline on mobile and user started different stint locally
- On reconnect: Dialog "Conflict detected"
  - Shows: Desktop stint (Client Website, 25 min remaining) vs Mobile stint (Personal Project, 5 min elapsed)
  - Options: Keep desktop stint, Keep mobile stint, Mark both interrupted
  - User chooses â†’ Server resolves, broadcasts to all devices

---

## Accessibility Considerations

### WCAG 2.1 Level AA Compliance

**Visual:**
- Color contrast ratio â‰¥4.5:1 for all text
- Focus indicators on all interactive elements (3px solid outline)
- Color not sole indicator (progress uses text + visual bar)
- Font size minimum 16px, scalable to 200% without layout breaking

**Keyboard Navigation:**
- Tab order follows visual flow
- All actions accessible via keyboard:
  - Enter/Space: Activate buttons
  - Escape: Close modals
  - Arrow keys: Navigate project cards
- Skip links: "Skip to main content", "Skip to navigation"

**Screen Readers:**
- Semantic HTML (nav, main, article, section)
- ARIA labels on all icon buttons
- Live regions for timer updates (aria-live="polite")
- Status announcements: "Stint started", "Stint completed"

**Cognitive:**
- Clear, simple language (8th grade reading level)
- Consistent UI patterns (modals always same structure)
- Visual feedback for all actions (loading states, confirmations)
- Error messages explain issue and solution

**Motor:**
- Touch targets â‰¥44x44px on mobile
- No time-based interactions (except stint timer, which can be paused)
- No precise hover required

---

**Related Documents:**
- [01-product-overview-strategy.md](./01-product-overview-strategy.md) - Product context and business rationale
- [03-feature-requirements.md](./03-feature-requirements.md) - Detailed feature specifications
- [06-implementation-guide.md](./06-implementation-guide.md) - Multi-device sync implementation details

# LifeStint - Feature Requirements

**Product Name:** LifeStint  
**Document Version:** 3.0  
**Date:** October 24, 2025

---

## 1. Project Organization

**Purpose:** Frictionless project management directly from dashboard.

### Capabilities

**Create Project:**
- Click "+ New Project" button on dashboard
- Modal appears with fields:
  - Project Name (required, 1-100 characters)
  - Expected Daily Stints (default: 2, range: 1-8)
  - Custom Stint Duration (optional, default: 120 minutes, range: 5-480 minutes)
  - Color Tag (optional, 8 preset colors)
- Validation: No duplicate names within user account
- Action: Creates project in "active" state

**Edit Project:**
- Click edit icon on project card
- Modal with editable fields (same as creation)
- Cannot change project ID or creation date
- Validation: Name uniqueness, valid ranges
- Action: Updates project, recalculates daily progress if daily stint expectation changed

**Activate/Deactivate:**
- Toggle switch on project card
- Active projects shown first in dashboard
- Inactive projects collapsed in "Inactive Projects" section
- Cannot deactivate project with active stint
- Deactivated projects excluded from daily totals and streaks

**Archive Project:**
- Archive option in edit modal (replaces delete)
- Confirmation dialog: "Archive [Project Name]? Past stints will be preserved for analytics."
- Archived projects hidden from dashboard, accessible via "View Archived" link
- All stint data preserved for analytics and exports

### Constraints

- Maximum 25 active projects per user (free tier: 2)
- Project names must be unique within user account
- Projects with active stints cannot be archived

---

## 2. Stint Management System

**Purpose:** Structure focused work with single-session enforcement and precise timing.

### Start Stint

- Click "Start" button on project card
- Confirmation modal if another project has active stint: "End current stint to start new one?"
- System checks server-side for active stints (prevents race conditions)
- Creates stint record with:
  - `started_at`: Server timestamp (UTC)
  - `planned_duration`: Project's custom duration or default 120 minutes
  - `status`: "active"
- Broadcasts real-time event to all user's connected devices
- Starts countdown timer on all devices

### Pause/Resume

- "Pause" button visible during active stint
- Pause action:
  - Sets `paused_at` to server timestamp
  - Sets `status` to "paused"
  - Timer freezes; working time stops accumulating
- Resume action:
  - Calculates pause duration in seconds: `now() - paused_at`
  - Adds to cumulative `paused_duration` (seconds)
  - Clears `paused_at`
  - Sets `status` to "active"
  - Timer resumes from remaining working time
- Pause/resume events broadcast in real-time
- Paused stints do not auto-complete; user must manually resume or stop

### Stop Stint Manually

- "Stop" button visible during active stint
- Optional notes modal: "Add notes about this stint?" (0-500 characters)
- Creates completion record:
  - `ended_at`: Server timestamp
  - `actual_duration`: Calculated from started_at to ended_at minus pause duration
  - `completion_type`: "manual"
  - `notes`: User input (optional)
- Progress updates on dashboard immediately
- Celebration animation if daily goal reached

### Auto-Complete

- Triggers when working time reaches planned duration (active stints only)
- Working time formula (in seconds): `(now - started_at) - paused_duration`
- Comparison: `working_time_seconds >= planned_duration_minutes * 60`
- Browser notification: "Stint auto-completed for [Project Name]! ðŸŽ‰"
- Auto-completes with:
  - `ended_at`: Server timestamp
  - `actual_duration`: Working time in seconds
  - `completion_type`: "auto"
  - `grace period`: 30 seconds for user to add notes
- If browser closed, server-side cron completes stint at planned end time
- Paused stints do not auto-complete

### Interruption Handling

- If network drops during active stint, local timer continues
- On reconnect, syncs with server state:
  - If server has no active stint: marks local stint as "interrupted", preserves data
  - If server has different active stint: shows conflict resolution dialog
- User can manually mark stint as "interrupted" with reason (0-200 characters)
- Interrupted stints don't count toward daily progress but preserved in analytics

### Single Active Stint Enforcement

- Server-side validation on stint start: checks for existing active stints for user
- If found, returns 409 Conflict with existing stint details
- Frontend shows resolution dialog:
  - Option 1: "End current stint and start new one"
  - Option 2: "Continue current stint"
  - Option 3: "Cancel"
- Race condition handling: Server uses optimistic locking (version field on user record)
- Cross-device: Real-time broadcasts ensure all devices show same active stint

### Timer Accuracy

- Frontend: Countdown timer in Web Worker (continues in background tabs)
- Backend: Server-side scheduled task checks for auto-completions every 30 seconds
- Sync: Every 60 seconds, frontend syncs with server to correct drift
- Offline: Local timer continues, reconciles on reconnect with server-authoritative time

### Constraints

- Only 1 active or paused stint per user across all devices
- Minimum stint duration: 5 minutes
- Maximum stint duration: 480 minutes
- Maximum 50 stints per project per day (anti-abuse)

---

## 3. Real-Time Dashboard

**Purpose:** Eliminate friction between deciding to focus and starting work.

### Layout

- Grid of project cards (1 on mobile and desktop)
- "Inactive Projects" collapsible section below
- "+ New Project" button in top right

### Project Card Contents

- Project name with color indicator
- Daily progress badge: "X of Y stints today" with visual progress bar
- Current streak: "ðŸ”¥ 5 day streak" (if >0)
- Last stint time: "2 hours ago" (relative)
- Action buttons:
  - "Start" (if no active stint)
  - "Stop" + "Pause" + timer (if this project has active stint)
  - "Resume" + paused time (if this project paused)
  - Edit icon
  - Activate/deactivate toggle

### Active Stint Highlighting

- Card expands vertically
- Pulsing green border animation
- Large countdown timer (MM:SS format)
- Pause/Stop buttons prominently displayed
- All other cards show "Stop current stint to start new one" instead of Start button

### Real-Time Updates

- Supabase Realtime subscription to user's stints
- Events trigger immediate UI updates:
  - Stint started: Update active project card, disable other Start buttons
  - Stint paused: Show Resume button, update pause time every second
  - Stint completed: Celebration animation, update progress badge
  - Progress reset: At midnight user's timezone, reset "X of Y" to "0 of Y"
- Optimistic updates: UI responds immediately, rollback if server rejects
- Reconnection: On network restore, fetches latest state and reconciles

### Daily Progress Reset

- Triggered at midnight in user's timezone (stored in user preferences)
- Backend scheduled task runs every hour, checks for users whose local midnight passed
- Resets daily progress counters to 0
- Preserves stint history for analytics
- Frontend subscribes to reset events, updates UI immediately

### Empty States

- No projects: "Start your first project" with "+ New Project" CTA
- No stints today: "Start your first stint of the day" with motivation quote
- All projects inactive: "Activate a project to get started"

### Error States

- Network offline: Banner "Working offline. Changes will sync when connected."
- Server error: Banner "Connection issues. Retrying..." with manual retry button
- Conflict detected: Modal with resolution options (described in Stint Management)

### Performance

- Dashboard loads in <2 seconds on 3G
- Real-time updates appear within 500ms of server event
- Smooth animations (60fps) on project card updates

---

## 4. Progress Analytics

**Purpose:** Provide motivation and professional evidence with minimal reporting overhead.

### Analytics View (Separate Page)

**Daily Summary:**
- Total stints completed today across all projects
- Total focus time (sum of actual durations)
- Average stint duration
- Projects worked on today (list with stint counts)
- Daily goal progress: "Met goal on 3 of 5 active projects"

**Weekly Summary:**
- 7-day overview with bar chart (stints per day)
- Total weekly stints and focus time
- Longest streak this week
- Most productive day
- Breakdown by project (top 5 by stint count)

**Streak Tracking:**
- Current streak: "ðŸ”¥ 12 day streak! Keep it going!"
- Longest streak all-time
- Streak definition: At least 1 completed stint per day (not interrupted)
- Grace period: 1 day (can miss 1 day without breaking streak)
- Timezone-aware: Streak calculated using user's timezone

**Focus Ledger Export:**
- "Export CSV" button in analytics view
- Generates CSV with columns:
  - Date (YYYY-MM-DD in user's timezone)
  - Project Name
  - Started At (YYYY-MM-DD HH:MM:SS in user's timezone)
  - Ended At
  - Planned Duration (minutes)
  - Actual Duration (minutes)
  - Pause Duration (minutes)
  - Completion Type
  - Notes
- Filename: `LifeStint-Focus-Ledger-[StartDate]-[EndDate].csv`
- Date range selector: Last 7 days, Last 30 days, Last 90 days, Custom
- Professional formatting: Clean, client-ready presentation
- Download triggers immediately (no email)

### Constraints

- Analytics limited to last 90 days in free tier, unlimited in Pro
- CSV exports limited to 10 per month in free tier, unlimited in Pro
- Charts use cached data (refreshes every 5 minutes)

---

## 5. User Authentication & Security

### Registration

- Email + password via Supabase Auth
- Password requirements:
  - Minimum 8 characters
  - At least 1 uppercase, 1 lowercase, 1 number
  - Common passwords blocked (10,000 most common)
- Email verification required before dashboard access
- Verification email sent immediately with 24-hour expiration
- Welcome email after verification with getting started guide

### Login

- Email + password
- "Remember me" checkbox (30-day session vs 24-hour)
- Rate limiting: 5 failed attempts per email per hour
- After 5 failures: CAPTCHA required
- After 10 failures: 1-hour lockout

### Password Recovery

- "Forgot password" link on login
- Email with secure reset link (6-hour expiration)
- Rate limiting: 3 reset emails per email per day
- Password reset requires new password (can't reuse last 3)

### Session Management

- JWT tokens with refresh rotation
- Automatic token refresh before expiration
- Device tracking: Shows "Active sessions" in settings
- "Log out all devices" option

### Security Measures

- HTTPS enforced on all endpoints
- Supabase encryption at rest and in transit
- Rate limiting on all authenticated endpoints
- No sensitive data in localStorage (tokens only in httpOnly cookies)
- CSRF protection via double-submit cookie pattern

---

**Related Documents:**
- [02-user-personas-flows.md](./02-user-personas-flows.md) - User experience flows
- [05-database-schema.md](./05-database-schema.md) - Database structure for these features
- [06-implementation-guide.md](./06-implementation-guide.md) - Technical implementation details

# LifeStint - Technical Architecture

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Vue 3 + Nuxt â”‚  â”‚ TanStack     â”‚  â”‚ Tailwind  â”‚ â”‚
â”‚  â”‚  Components  â”‚  â”‚ Query        â”‚  â”‚    CSS    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Supabase Client (JS SDK)               â”‚  â”‚
â”‚  â”‚   Auth â€¢ Realtime â€¢ Database â€¢ Storage       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                  HTTPS / WebSocket
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Supabase Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚   Realtime   â”‚  â”‚  Storage  â”‚ â”‚
â”‚  â”‚  + RLS       â”‚  â”‚   Server     â”‚  â”‚           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      Database Functions & pg_cron             â”‚  â”‚
â”‚  â”‚  â€¢ Auto-Complete Stint (pg_cron)             â”‚  â”‚
â”‚  â”‚  â€¢ Daily Summary Aggregation (pg_cron)       â”‚  â”‚
â”‚  â”‚  â€¢ Business Logic (PL/pgSQL Functions)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   External Services
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Sentry  â”‚  â”‚ Mixpanel â”‚  â”‚   Email Service  â”‚  â”‚
â”‚  â”‚  (Errors)â”‚  â”‚(Analytics)â”‚  â”‚   (Supabase)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Frontend Stack

### Framework

- **Vue 3** (Composition API)
  - Reactive state management
  - Component-based architecture
  - TypeScript support
- **Nuxt 3** (Vue meta-framework)
  - File-based routing
  - SSR/SSG capabilities (for marketing pages)
  - Auto-imports for components
  - Built-in optimization

### UI Framework

- **Nuxt UI 4**
  - Pre-built accessible components
  - Dark mode support out of box
  - Tailwind CSS integration
  - Minimal custom CSS needed

### State Management

- **TanStack Query (Vue Query)**
  - Pure query-based architecture (no Pinia/Vuex stores)
  - All server state managed through TanStack Query cache
  - Automatic caching with configurable stale times
  - Background refetching and cache invalidation
- **Query Key Factory Pattern**
  - Centralized cache key organization
  - Hierarchical keys for targeted invalidation
  - Type-safe query key definitions
- **Optimistic Updates**
  - Immediate UI feedback before server response
  - Automatic rollback on mutation failure
  - Cache snapshot and restore on error
- **Composables**
  - useStintTimer (Web Worker singleton for accurate timing)
  - useRealtime (Supabase subscription wrapper)
  - useAuth (Auth state management)

### Styling

- **Tailwind CSS 3** (via Nuxt UI)
  - Utility-first styling
  - Responsive design system
  - Dark mode variants
  - Semantic color palette (primary, secondary, success, warning, error, neutral)

### Charts (Post-MVP)

- **Chart.js**
  - Bar charts for daily/weekly summaries
  - Line charts for trend analysis
  - Lightweight, tree-shakeable

### Real-Time

- **Supabase Realtime Client**
  - WebSocket connections
  - Automatic reconnection
  - Subscription management
  - Broadcast events for stint updates

### Background Processing

- **Web Workers**
  - Timer accuracy in background tabs
  - CSV generation (offload from main thread)
  - Notification scheduling

### Build & Dev

- **Vite** (bundler)
- **TypeScript** (type safety)
- **ESLint + Prettier** (code quality)

---

## Backend Stack

### Database

- **Supabase PostgreSQL**
  - Version: PostgreSQL 15
  - Hosting: Managed by Supabase (AWS)
  - Row Level Security (RLS) for multi-tenancy
  - Full-text search capabilities
  - JSON/JSONB for flexible data

### Authentication

- **Supabase Auth**
  - JWT tokens with refresh rotation
  - Email verification workflow
  - Password reset with secure tokens
  - Session management across devices
  - OAuth providers (future: Google, Microsoft)

### Real-Time Sync

- **Supabase Realtime**
  - PostgreSQL replication to WebSockets
  - Row-level broadcasts
  - Channel-based subscriptions
  - User-specific channels for privacy

### Storage

- **Supabase Storage**
  - CSV export temporary files
  - User-uploaded files (future: stint attachments)
  - Auto-cleanup of temp files (24-hour retention)

### Server-Side Logic

- **Direct Supabase Client Model**
  - All CRUD operations via Supabase JS SDK with Row Level Security (RLS)
  - Client calls database directly through Supabase PostgREST API
  - No Edge Functions required for business logic
  - Validation handled via Zod schemas on client, database constraints on server

- **Scheduled Tasks via pg_cron**
  - `auto_complete_stints`: Auto-completes stints at planned end time (runs every 30 sec)
  - `aggregate_daily_stats`: Pre-calculates daily summaries (runs at midnight)

- **CSV Export**
  - Generated client-side using stint data from database queries
  - No server-side processing required

### Database Functions

- **PostgreSQL Functions** (PL/pgSQL)
  - `calculate_streak`: Computes current streak for user
  - `aggregate_daily_stats`: Pre-calculates daily summaries (runs at midnight)
  - `validate_stint_start`: Server-side validation for race conditions
  - `resolve_stint_conflict`: Conflict resolution algorithm

### Scheduled Jobs

- **pg_cron** (PostgreSQL extension)
  - Daily aggregation: `0 1 * * *` (1 AM UTC)
  - Cleanup old sessions: `0 2 * * *` (2 AM UTC)
  - Email digests: `0 8 * * 1` (8 AM UTC every Monday)

---

## Real-Time Sync Strategy

### Architecture

- **Supabase Realtime** provides WebSocket connections
- PostgreSQL changes trigger real-time events
- Frontend subscribes to user-specific channels
- Events broadcast to all user's connected devices

### Event Types

- **Stint Started:** Broadcasts to all devices when stint begins
- **Stint Paused:** Updates pause state across devices
- **Stint Resumed:** Resumes countdown on all devices
- **Stint Completed:** Triggers celebration and progress updates
- **Daily Reset:** Broadcasts midnight reset events

### Conflict Prevention

- Optimistic locking via `users.version` field
- Server-authoritative timestamps
- Real-time events prevent stale state
- See [06-implementation-guide.md](./06-implementation-guide.md) for detailed conflict resolution

---

## Monitoring & Observability

### Error Tracking

- **Sentry**
  - Frontend errors (uncaught exceptions)
  - Database query failures (via client error handling)
  - Performance monitoring
  - User feedback widget
  - Alert rules: >10 errors in 5 min â†’ Slack notification

### Analytics (Post-MVP)

- **Mixpanel**
  - User events: stint_started, stint_completed, project_created
  - Funnel analysis: Registration â†’ First stint â†’ 7-day retention
  - Cohort analysis: Free vs Pro retention
  - A/B test tracking

### Performance

- **Core Web Vitals** (native browser APIs)
  - LCP (Largest Contentful Paint): <2.5s
  - FID (First Input Delay): <100ms
  - CLS (Cumulative Layout Shift): <0.1
- **Custom Metrics**:
  - Dashboard load time
  - Real-time sync latency
  - Timer drift measurement

### Uptime Monitoring

- **BetterUptime** (future)
  - HTTP checks every 30 seconds
  - WebSocket connection health
  - Database query performance
  - Alert via PagerDuty for downtime

### Logging

- **Supabase Logs** (built-in)
  - Database query logs
  - pg_cron job execution logs
  - Auth event logs
  - Retention: 7 days free tier, 30 days Pro

---

## Infrastructure

### Hosting

- **Supabase Cloud**
  - Database: AWS us-east-1 (primary), multi-AZ
  - Scheduled Jobs: pg_cron extension
  - Storage: AWS S3
  - CDN: Cloudflare

### Domains & SSL

- **Primary:** lifestint.com (frontend)
- **API:** api.lifestint.com (Supabase proxy)
- **SSL:** Cloudflare Universal SSL (automatic)

### Environments

- **Production:** lifestint.com (Supabase Production project)
- **Staging:** staging.lifestint.com (Supabase Staging project)
- **Development:** localhost:3005 (Local Supabase via Docker)

### CI/CD

- **GitHub Actions**
  - On push to `main`: Deploy to Staging
  - On release tag: Deploy to Production
  - Automated tests: Unit, integration, E2E (Playwright)
  - Lint checks: ESLint, TypeScript
  - Build time: <5 minutes

### Backups

- **Supabase Automated Backups**
  - Daily full backups (retained 7 days)
  - Point-in-time recovery (last 7 days)
  - Manual backup before major migrations

---

## Security Architecture

### Network Security

- HTTPS enforced (HSTS enabled)
- CSP headers: Restrict inline scripts
- CORS: Whitelist frontend domains only
- Rate limiting: Cloudflare + Supabase built-in

### Data Security

- Encryption at rest: AWS KMS (Supabase default)
- Encryption in transit: TLS 1.3
- Database backups encrypted
- No PII in logs

### Authentication Security

- Password hashing: bcrypt (cost factor 12)
- JWT signing: RS256 (asymmetric keys)
- Refresh token rotation on use
- Session invalidation on logout

### Authorization

- Row Level Security (RLS) on all tables
- User can only access own data
- API keys scoped per environment
- Service role key only used by pg_cron jobs (never exposed to client)

### Compliance

- **GDPR:**
  - Data export API
  - Account deletion with cascade
  - Cookie consent banner
  - Privacy policy
- **CCPA:**
  - Do Not Sell opt-out
  - Data access requests
- **SOC 2:** (future, via Supabase certification)

---

**Related Documents:**
- [05-database-schema.md](./05-database-schema.md) - Complete database structure
- [06-implementation-guide.md](./06-implementation-guide.md) - Implementation details for complex features
- [09-operations-compliance.md](./09-operations-compliance.md) - Operations and security details

# LifeStint - Database Schema & Data Models

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## Schema Version: 1.0

---

## Users Table

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  timezone TEXT NOT NULL DEFAULT 'UTC',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  email_verified BOOLEAN NOT NULL DEFAULT false,
  last_active TIMESTAMPTZ,
  version INTEGER NOT NULL DEFAULT 1, -- Optimistic locking
  CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'),
  CONSTRAINT valid_timezone CHECK (timezone IN (SELECT name FROM pg_timezone_names))
);

-- Indexes
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_last_active ON users(last_active);

-- RLS Policies
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read own data" ON users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own data" ON users FOR UPDATE USING (auth.uid() = id);

-- Trigger for updated_at
CREATE TRIGGER set_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Field Descriptions:**
- `timezone`: IANA timezone (e.g., "America/New_York") for daily reset and exports
- `version`: Incremented on every update for optimistic locking (prevents race conditions)
- `email_verified`: Must be true to access dashboard
- `last_active`: Updated on each API request, used for inactive user cleanup

**Constraints:**
- Email must be valid format and unique
- Timezone must be valid IANA timezone

**Relationships:**
- One-to-many with `projects` (CASCADE on delete)
- One-to-many with `stints` (CASCADE on delete)
- One-to-one with `user_preferences` (CASCADE on delete)
- One-to-one with `user_streaks` (CASCADE on delete)
- One-to-many with `daily_summaries` (CASCADE on delete)

---

## Projects Table

```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  expected_daily_stints INTEGER NOT NULL DEFAULT 2,
  custom_stint_duration INTEGER, -- Minutes, NULL means use default (120)
  color_tag TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  archived_at TIMESTAMPTZ, -- NULL if not archived
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT valid_name CHECK (length(name) >= 1 AND length(name) <= 100),
  CONSTRAINT valid_daily_stints CHECK (expected_daily_stints >= 1 AND expected_daily_stints <= 8),
  CONSTRAINT valid_stint_duration CHECK (custom_stint_duration IS NULL OR
    (custom_stint_duration >= 5 AND custom_stint_duration <= 480)),
  CONSTRAINT valid_color CHECK (color_tag IS NULL OR color_tag IN 
    ('red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'gray')),
  CONSTRAINT unique_name_per_user UNIQUE (user_id, name)
);

-- Indexes
CREATE INDEX idx_projects_user_active ON projects(user_id, is_active) WHERE archived_at IS NULL;
CREATE INDEX idx_projects_user_sort ON projects(user_id, sort_order);

-- RLS Policies
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own projects" ON projects FOR ALL USING (auth.uid() = user_id);

-- Trigger for updated_at
CREATE TRIGGER set_projects_updated_at BEFORE UPDATE ON projects
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Function to count active projects per user
CREATE FUNCTION count_active_projects(p_user_id UUID) RETURNS INTEGER AS $$
  SELECT COUNT(*)::INTEGER FROM projects 
  WHERE user_id = p_user_id AND is_active = true AND archived_at IS NULL;
$$ LANGUAGE SQL STABLE;
```

**Field Descriptions:**
- `custom_stint_duration`: Overrides default 120 minutes if set
- `color_tag`: Visual identifier in dashboard (8 preset colors)
- `archived_at`: Soft delete timestamp (NULL if active)
- `sort_order`: User-defined ordering (0 = first), future drag-to-reorder

**Constraints:**
- Project names must be unique per user
- Expected daily stints: 1-8
- Custom stint duration: 5-480 minutes if specified
- Maximum 25 active projects per user (enforced in application logic)

**Business Rules:**
- Archiving a project with active stint is prevented by application logic
- Archived projects excluded from daily totals and streak calculations

**Relationships:**
- Many-to-one with `users` (CASCADE on delete)
- One-to-many with `stints` (CASCADE on delete)

---

## Stints Table

```sql
CREATE TABLE stints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- Denormalized for query performance
  started_at TIMESTAMPTZ NOT NULL,
  ended_at TIMESTAMPTZ,
  planned_duration INTEGER NOT NULL, -- Minutes
  actual_duration INTEGER, -- Seconds, calculated on completion
  paused_duration INTEGER NOT NULL DEFAULT 0, -- Seconds
  completion_type TEXT CHECK (completion_type IN ('manual', 'auto', 'interrupted')),
  notes TEXT,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused', 'completed', 'interrupted')),
  paused_at TIMESTAMPTZ, -- Most recent pause time
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT valid_planned_duration CHECK (planned_duration >= 5 AND planned_duration <= 480),
  CONSTRAINT valid_notes CHECK (notes IS NULL OR length(notes) <= 500),
  CONSTRAINT valid_ended CHECK (ended_at IS NULL OR ended_at >= started_at),
  CONSTRAINT completed_has_ended CHECK (status IN ('active', 'paused') OR ended_at IS NOT NULL)
);

-- Indexes
CREATE INDEX idx_stints_user_date ON stints(user_id, started_at DESC);
CREATE INDEX idx_stints_project_date ON stints(project_id, started_at DESC);
CREATE INDEX idx_stints_active ON stints(user_id) WHERE status IN ('active', 'paused');
CREATE INDEX idx_stints_completed_date ON stints(user_id, DATE(started_at AT TIME ZONE (SELECT timezone FROM users WHERE id = stints.user_id)));

-- RLS Policies
ALTER TABLE stints ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own stints" ON stints FOR ALL USING (auth.uid() = user_id);

-- Function to get active stint for user
CREATE FUNCTION get_active_stint(p_user_id UUID) RETURNS SETOF stints AS $$
  SELECT * FROM stints 
  WHERE user_id = p_user_id AND status IN ('active', 'paused')
  LIMIT 1;
$$ LANGUAGE SQL STABLE;

-- Function to complete stint
CREATE FUNCTION complete_stint(
  p_stint_id UUID,
  p_completion_type TEXT,
  p_notes TEXT DEFAULT NULL
) RETURNS VOID AS $$
DECLARE
  v_started_at TIMESTAMPTZ;
  v_paused_duration INTEGER;
BEGIN
  SELECT started_at, paused_duration INTO v_started_at, v_paused_duration
  FROM stints WHERE id = p_stint_id;
  
  UPDATE stints SET
    ended_at = now(),
    actual_duration = EXTRACT(EPOCH FROM (now() - v_started_at))::INTEGER - v_paused_duration,
    completion_type = p_completion_type,
    notes = p_notes,
    status = 'completed'
  WHERE id = p_stint_id;
END;
$$ LANGUAGE plpgsql;
```

**Field Descriptions:**
- `user_id`: Denormalized for faster queries (no join needed)
- `planned_duration`: Stint length in **minutes** (5-480)
- `actual_duration`: Total working time in **seconds**, calculated on completion
- `paused_duration`: Cumulative pause time in **seconds**
- `status`: Current state (active, paused, completed, interrupted)
- `paused_at`: Timestamp when current pause started; NULL when active or completed

**Constraints:**
- Planned duration: 5-480 minutes
- Notes: Max 500 characters
- Completed stints must have ended_at

**Business Rules:**
- Only one active/paused stint per user (enforced by unique partial index)
- Auto-completion triggered when working time reaches planned duration (active stints only)
- Working time (seconds): `EXTRACT(EPOCH FROM (now() - started_at)) - paused_duration`
- Comparison: `working_time_seconds >= planned_duration_minutes * 60`
- Paused stints do not auto-complete; working time is frozen while paused
- Interrupted stints don't count toward daily progress but preserved in history

**Relationships:**
- Many-to-one with `projects` (CASCADE on delete)
- Many-to-one with `users` (CASCADE on delete)

---

## User Preferences Table

```sql
CREATE TABLE user_preferences (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  default_stint_duration INTEGER NOT NULL DEFAULT 120,
  celebration_sound BOOLEAN NOT NULL DEFAULT true,
  celebration_animation BOOLEAN NOT NULL DEFAULT true,
  desktop_notifications BOOLEAN NOT NULL DEFAULT true,
  weekly_email_digest BOOLEAN NOT NULL DEFAULT false,
  theme TEXT NOT NULL DEFAULT 'system' CHECK (theme IN ('light', 'dark', 'system')),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT valid_default_duration CHECK (default_stint_duration >= 5 AND default_stint_duration <= 480)
);

-- RLS Policy
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own preferences" ON user_preferences FOR ALL USING (auth.uid() = user_id);

-- Trigger for updated_at
CREATE TRIGGER set_preferences_updated_at BEFORE UPDATE ON user_preferences
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Field Descriptions:**
- `default_stint_duration`: Default for new projects (can be overridden per project)
- `celebration_*`: Control completion animations and sounds
- `desktop_notifications`: Browser notifications for stint completion
- `theme`: UI theme preference

**Relationships:**
- One-to-one with `users` (CASCADE on delete)

---

## Daily Summaries Table (Pre-Aggregated for Performance)

```sql
CREATE TABLE daily_summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  total_stints INTEGER NOT NULL DEFAULT 0,
  total_focus_seconds INTEGER NOT NULL DEFAULT 0,
  total_pause_seconds INTEGER NOT NULL DEFAULT 0,
  projects_worked JSONB NOT NULL DEFAULT '[]', -- Array of {project_id, project_name, stint_count}
  completed_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT unique_user_date UNIQUE (user_id, date)
);

-- Indexes
CREATE INDEX idx_daily_summaries_user_date ON daily_summaries(user_id, date DESC);

-- RLS Policy
ALTER TABLE daily_summaries ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read own summaries" ON daily_summaries FOR SELECT USING (auth.uid() = user_id);

-- Function to aggregate daily summary (called by cron)
CREATE FUNCTION aggregate_daily_summary(p_user_id UUID, p_date DATE) RETURNS VOID AS $$
DECLARE
  v_timezone TEXT;
BEGIN
  SELECT timezone INTO v_timezone FROM users WHERE id = p_user_id;
  
  INSERT INTO daily_summaries (user_id, date, total_stints, total_focus_seconds, total_pause_seconds, projects_worked)
  SELECT 
    p_user_id,
    p_date,
    COUNT(*) as total_stints,
    SUM(actual_duration) as total_focus_seconds,
    SUM(paused_duration) as total_pause_seconds,
    jsonb_agg(jsonb_build_object(
      'project_id', project_id,
      'project_name', (SELECT name FROM projects WHERE id = project_id),
      'stint_count', COUNT(*)
    )) as projects_worked
  FROM stints
  WHERE user_id = p_user_id 
    AND status = 'completed'
    AND DATE(started_at AT TIME ZONE v_timezone) = p_date
  GROUP BY user_id
  ON CONFLICT (user_id, date) DO UPDATE SET
    total_stints = EXCLUDED.total_stints,
    total_focus_seconds = EXCLUDED.total_focus_seconds,
    total_pause_seconds = EXCLUDED.total_pause_seconds,
    projects_worked = EXCLUDED.projects_worked,
    completed_at = now();
END;
$$ LANGUAGE plpgsql;
```

**Purpose:**
- Pre-aggregates daily stats for fast analytics queries
- Avoids expensive SUM() queries on stints table for every analytics page load
- Generated nightly by scheduled task

**Relationships:**
- Many-to-one with `users` (CASCADE on delete)

---

## Streak Tracking Table

```sql
CREATE TABLE user_streaks (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  current_streak INTEGER NOT NULL DEFAULT 0,
  longest_streak INTEGER NOT NULL DEFAULT 0,
  last_stint_date DATE,
  streak_updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- RLS Policy
ALTER TABLE user_streaks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read own streaks" ON user_streaks FOR SELECT USING (auth.uid() = user_id);

-- Function to calculate streak
CREATE FUNCTION calculate_streak(p_user_id UUID) RETURNS INTEGER AS $$
DECLARE
  v_streak INTEGER := 0;
  v_current_date DATE;
  v_timezone TEXT;
  v_last_date DATE;
BEGIN
  SELECT timezone INTO v_timezone FROM users WHERE id = p_user_id;
  SELECT DATE(now() AT TIME ZONE v_timezone) INTO v_current_date;
  SELECT last_stint_date INTO v_last_date FROM user_streaks WHERE user_id = p_user_id;
  
  -- If last stint was today or yesterday, count streak
  IF v_last_date IS NOT NULL AND v_last_date >= v_current_date - INTERVAL '1 day' THEN
    -- Count consecutive days with stints going backwards from last_date
    SELECT COUNT(*) INTO v_streak FROM (
      SELECT DISTINCT DATE(started_at AT TIME ZONE v_timezone) as stint_date
      FROM stints
      WHERE user_id = p_user_id AND status = 'completed'
      ORDER BY stint_date DESC
    ) AS daily_stints
    WHERE stint_date >= v_current_date - INTERVAL '1 day' * v_streak;
  END IF;
  
  RETURN v_streak;
END;
$$ LANGUAGE plpgsql;
```

**Relationships:**
- One-to-one with `users` (CASCADE on delete)

---

## Audit Log Table (For Support & Debugging)

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  entity_type TEXT NOT NULL, -- 'project', 'stint', 'user_preferences'
  entity_id UUID,
  old_values JSONB,
  new_values JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id);

-- No RLS (internal only, accessed via pg_cron jobs with service role)
```

**Purpose:**
- Track user actions for support investigations
- Debug stint conflicts and data inconsistencies
- Not exposed to users (internal only)

**Retention:**
- 90 days (cleanup via scheduled task)

---

## Row Level Security (RLS) Policies

### Users Table

```sql
-- Users can read own profile
CREATE POLICY "users_select_own" ON users FOR SELECT 
USING (auth.uid() = id);

-- Users can update own profile (except id, created_at)
CREATE POLICY "users_update_own" ON users FOR UPDATE 
USING (auth.uid() = id)
WITH CHECK (id = auth.uid() AND created_at = (SELECT created_at FROM users WHERE id = auth.uid()));
```

### Projects Table

```sql
-- Users can read own projects
CREATE POLICY "projects_select_own" ON projects FOR SELECT 
USING (auth.uid() = user_id);

-- Users can insert own projects
CREATE POLICY "projects_insert_own" ON projects FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- Users can update own projects
CREATE POLICY "projects_update_own" ON projects FOR UPDATE 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Users can delete own projects (actually archives via application logic)
CREATE POLICY "projects_delete_own" ON projects FOR DELETE 
USING (auth.uid() = user_id);
```

### Stints Table

```sql
-- Users can read own stints
CREATE POLICY "stints_select_own" ON stints FOR SELECT 
USING (auth.uid() = user_id);

-- Users can insert own stints
CREATE POLICY "stints_insert_own" ON stints FOR INSERT 
WITH CHECK (auth.uid() = user_id AND 
  EXISTS (SELECT 1 FROM projects WHERE id = project_id AND user_id = auth.uid()));

-- Users can update own stints (for pause/resume/stop)
CREATE POLICY "stints_update_own" ON stints FOR UPDATE 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Users cannot delete stints (immutable record)
-- No DELETE policy = no deletions allowed
```

### Daily Summaries Table

```sql
-- Users can read own summaries
CREATE POLICY "summaries_select_own" ON daily_summaries FOR SELECT 
USING (auth.uid() = user_id);

-- Users cannot write summaries (generated by cron with service role key)
-- No INSERT/UPDATE policies = only system can write
```

### Service Role Bypass

- pg_cron jobs run with service role privileges (bypasses RLS)
- Used for:
  - Auto-completing stints (scheduled job)
  - Generating daily summaries (scheduled job)
  - System maintenance operations
- Service role never exposed to frontend (only used server-side by pg_cron)

### Testing RLS

```sql
-- Test as user
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims.sub = 'user-uuid-here';

-- Attempt to read another user's data (should return 0 rows)
SELECT * FROM projects WHERE user_id != 'user-uuid-here';

-- Attempt to insert with wrong user_id (should fail)
INSERT INTO projects (user_id, name) VALUES ('other-user-uuid', 'Test');
```

---

## Database Functions

### Utility Functions

**update_updated_at_column()**
- Automatically updates `updated_at` timestamp on row updates
- Used by triggers on all tables with `updated_at` field

### Business Logic Functions

**get_active_stint(p_user_id UUID)**
- Returns the active or paused stint for a user
- Used to check for existing active stints before starting new one

**complete_stint(p_stint_id UUID, p_completion_type TEXT, p_notes TEXT)**
- Completes a stint by calculating actual duration and updating status
- Used by both manual stop and auto-completion logic

**calculate_streak(p_user_id UUID)**
- Calculates current streak for a user based on completed stints
- Timezone-aware, includes grace period logic

**aggregate_daily_summary(p_user_id UUID, p_date DATE)**
- Pre-aggregates daily statistics for performance
- Called by cron job at midnight user time

**count_active_projects(p_user_id UUID)**
- Returns count of active (non-archived) projects for a user
- Used to enforce project limits

---

## Indexes Summary

**Performance-Critical Indexes:**
- `idx_users_email`: Fast user lookup by email
- `idx_projects_user_active`: Fast active project queries
- `idx_stints_user_date`: Fast stint history queries
- `idx_stints_active`: Fast active stint lookup
- `idx_daily_summaries_user_date`: Fast analytics queries

**Partial Indexes:**
- `idx_projects_user_active`: Only indexes non-archived projects
- `idx_stints_active`: Only indexes active/paused stints

---

**Related Documents:**
- [04-technical-architecture.md](./04-technical-architecture.md) - Technical architecture context
- [06-implementation-guide.md](./06-implementation-guide.md) - Implementation details using this schema
- [09-operations-compliance.md](./09-operations-compliance.md) - Database migration strategy

# LifeStint - Technical Implementation Guide

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## Timezone Handling

### User Timezone Storage

- Captured during registration (browser timezone detected via Intl.DateTimeFormat)
- Stored in `users.timezone` as IANA timezone string (e.g., "America/New_York")
- User can change in settings (dropdown of common timezones)

### Daily Reset Logic

- Scheduled task runs every hour at :00
- Queries users whose local midnight occurred in the last hour: 
  ```sql
  SELECT * FROM users 
  WHERE EXTRACT(HOUR FROM now() AT TIME ZONE timezone) = 0 
    AND EXTRACT(MINUTE FROM now() AT TIME ZONE timezone) < 10
  ```
- Resets daily progress counters for matched users
- Triggers daily summary aggregation for previous day

### CSV Export Timestamps

- All timestamps converted to user's timezone
- Format: `YYYY-MM-DD HH:MM:SS` with timezone label in header
- Example: "2025-10-24 09:30:00 (America/New_York)"

### Streak Calculation

- Uses user's timezone to determine "today" and "yesterday"
- Query: `DATE(started_at AT TIME ZONE v_timezone)`
- Grace period: 1 day (can miss 1 day without breaking streak)

### Edge Cases

- **Timezone change:** Daily reset recalculates based on new timezone immediately
- **DST transitions:** PostgreSQL handles automatically with AT TIME ZONE
- **Traveling users:** Timezone can be manually changed in settings

---

## Offline Sync Strategy

### Offline Capabilities

- Start/pause/resume/stop stints (queued locally)
- View cached dashboard data
- Timer continues in Web Worker using local system clock

### Offline Storage

- IndexedDB for queued operations (via Dexie.js)
- LocalStorage for last known dashboard state
- Service Worker for app shell caching (PWA)

### Online Reconciliation

**1. Detecting Offline State:**
- `navigator.onLine` event listener
- Heartbeat API call every 30 seconds
- WebSocket disconnect triggers offline mode

**2. Queuing Operations:**
```javascript
// Offline queue structure
{
  id: 'uuid',
  operation: 'start_stint' | 'stop_stint' | 'pause_stint' | 'resume_stint',
  payload: { project_id, started_at, ... },
  timestamp: Date.now(),
  retries: 0
}
```

**3. Sync on Reconnect:**
- Prioritize: Active stint sync first (prevents conflicts)
- Process queue in chronological order
- Server validates each operation:
  - Check for conflicts (another stint started)
  - Validate timestamps (no future dates)
  - Ensure operation is still valid (project not archived)

**4. Conflict Resolution:**

**Scenario: User starts stint offline on Device A, comes online on Device B, starts different stint**
- Device B syncs, sees Device A has pending start operation
- Server detects conflict: Two start operations without stop
- Resolution strategy: Server-authoritative timestamp
  - Earlier timestamp wins
  - Later operation rejected with 409 Conflict
  - Frontend on Device A shows modal: "Another stint was started while offline. Mark this stint as interrupted?"

**Scenario: User stops stint offline, server already auto-completed it**
- Server compares timestamps
- If manual stop is within 5 minutes of auto-complete time: Accept manual stop (more accurate)
- If manual stop is >5 minutes after auto-complete: Reject with message "Stint already completed"

**Data Loss Prevention:**
- All queued operations persisted in IndexedDB (survives browser close)
- Failed sync operations retried with exponential backoff (max 3 retries)
- After 3 failures: Show "Sync failed" with manual retry button

**Limitations:**
- Cannot create/edit/archive projects offline (requires network)
- Analytics and exports require network
- Real-time sync disabled offline (obviously)

---

## Pause/Resume Mechanics

### Database Field Units

| Field | Unit | Description |
|-------|------|-------------|
| `planned_duration` | minutes | User-configured stint length |
| `paused_duration` | seconds | Cumulative time spent paused |
| `actual_duration` | seconds | Total working time on completion |
| `paused_at` | timestamp | When current pause started |

### State Transitions

```
ACTIVE â”€â”€pauseâ”€â”€â–¶ PAUSED â”€â”€resumeâ”€â”€â–¶ ACTIVE
   â”‚                 â”‚
   â””â”€â”€stopâ”€â”€â–¶ COMPLETED â—€â”€â”€stopâ”€â”€â”˜
```

### Pause Operation

1. Validate stint is active
2. Set `paused_at = now()`
3. Set `status = 'paused'`
4. Broadcast pause event via Realtime
5. Frontend freezes timer display

### Resume Operation

1. Validate stint is paused
2. Calculate pause duration in seconds: `pause_seconds = EXTRACT(EPOCH FROM (now() - paused_at))`
3. Accumulate: `paused_duration = paused_duration + pause_seconds`
4. Clear: `paused_at = NULL`
5. Set `status = 'active'`
6. Broadcast resume event via Realtime
7. Frontend resumes timer from remaining working time

### Stop While Paused

If user stops a paused stint:
1. Calculate final pause in seconds: `pause_seconds = EXTRACT(EPOCH FROM (now() - paused_at))`
2. Accumulate: `paused_duration = paused_duration + pause_seconds`
3. Calculate actual duration in seconds: `actual_duration = EXTRACT(EPOCH FROM (ended_at - started_at)) - paused_duration`
4. Set `status = 'completed'`

### Working Time Calculation

At any moment, the elapsed working time in seconds is:

```
If status = 'active':
  working_seconds = EXTRACT(EPOCH FROM (now() - started_at)) - paused_duration

If status = 'paused':
  current_pause_seconds = EXTRACT(EPOCH FROM (now() - paused_at))
  working_seconds = EXTRACT(EPOCH FROM (now() - started_at)) - paused_duration - current_pause_seconds
```

Timer displays remaining time:
```
remaining_seconds = (planned_duration * 60) - working_seconds
```

---

## Real-Time Conflict Resolution

### Conflict Scenarios

**1. Simultaneous Stint Start (Race Condition):**
- User clicks "Start" on Device A
- Before response, user clicks "Start" on Device B
- Both requests reach server

**Resolution:**
- Server uses optimistic locking on `users.version` field
- First request increments version, succeeds
- Second request fails with 409 Conflict (version mismatch)
- Device B shows: "You already started a stint on another device. View it?"
- Button opens current active stint

**2. Pause/Resume Conflicts:**
- User pauses on Device A
- Before real-time event propagates, user resumes on Device B

**Resolution:**
- Each pause/resume increments stint's `version` field
- Server rejects stale operation with 409 Conflict
- Frontend refetches latest stint state
- UI updates to show current state

**3. Stop Conflicts:**
- User stops stint on Device A (network slow)
- Timer reaches 0 on Device B, auto-completes
- Device A's manual stop request arrives after

**Resolution:**
- Server checks if stint already completed
- If completed <5 minutes ago: Accept manual stop notes (merge)
- If completed >5 minutes ago: Reject with "Already completed"

**4. Offline Divergence:**
- Device A offline: Starts Stint X, works for 30 min
- Device B online: Starts Stint Y, completes it
- Device A comes online, tries to sync Stint X

**Resolution:**
- Server sees Device B completed stint after Device A started (based on timestamps)
- Server rejects Device A's stint start
- Frontend shows: "Another stint was started while offline"
- Options:
  - Mark local stint as "interrupted" (preserves data)
  - Discard local stint
- If "interrupted": Local stint saved with `status: 'interrupted'`, doesn't count toward progress

### Implementation

```sql
-- Optimistic locking check before stint start
CREATE FUNCTION start_stint(p_user_id UUID, p_project_id UUID, p_version INTEGER) 
RETURNS SETOF stints AS $$
BEGIN
  -- Check version matches (no concurrent operations)
  IF (SELECT version FROM users WHERE id = p_user_id) != p_version THEN
    RAISE EXCEPTION 'Conflict: User version mismatch';
  END IF;
  
  -- Check no active stints
  IF EXISTS (SELECT 1 FROM stints WHERE user_id = p_user_id AND status IN ('active', 'paused')) THEN
    RAISE EXCEPTION 'Conflict: Active stint exists';
  END IF;
  
  -- Increment version
  UPDATE users SET version = version + 1 WHERE id = p_user_id;
  
  -- Create stint
  RETURN QUERY INSERT INTO stints (...) VALUES (...) RETURNING *;
END;
$$ LANGUAGE plpgsql;
```

---

## Timer Accuracy & Background Tabs

### Problem

- Browser throttles timers in background tabs (1-second resolution becomes 1-minute+)
- User switches tabs or minimizes browser, timer appears to "freeze"

### Solution: Web Worker Timer

**Architecture:**
```
Main Thread (UI)          Web Worker
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startStint()    â”€â”€â”€â”€â”€â”€â”€â”€> startTimer(duration)
                          â†“
updateUI()      <â”€â”€â”€â”€â”€â”€â”€â”€ postMessage({ secondsRemaining })
                          (every 1 second)
                          â†“
stintComplete() <â”€â”€â”€â”€â”€â”€â”€â”€ postMessage({ completed: true })
```

**Implementation:**
```javascript
// worker.js
let intervalId;
let endTime;

self.onmessage = (e) => {
  if (e.data.action === 'start') {
    endTime = Date.now() + e.data.duration * 1000;
    intervalId = setInterval(() => {
      const remaining = Math.max(0, endTime - Date.now());
      self.postMessage({ secondsRemaining: Math.floor(remaining / 1000) });
      if (remaining <= 0) {
        clearInterval(intervalId);
        self.postMessage({ completed: true });
      }
    }, 1000);
  } else if (e.data.action === 'stop') {
    clearInterval(intervalId);
  }
};
```

### Server-Side Validation

- Every 60 seconds, frontend syncs with server: `GET /api/stints/active`
- Server returns actual remaining time based on `started_at`
- Frontend corrects timer if drift >5 seconds
- Prevents manipulation (user can't hack local timer)

### Auto-Completion Fallback

- pg_cron job runs every 30 seconds
- Queries active stints where working time has reached planned duration:
  ```sql
  SELECT * FROM stints
  WHERE status = 'active'
    AND (EXTRACT(EPOCH FROM (now() - started_at)) - paused_duration)
        >= (planned_duration * 60)
  ```
  - `EXTRACT(EPOCH FROM ...)` returns seconds
  - `paused_duration` is stored in seconds
  - `planned_duration` is stored in minutes, multiplied by 60 for comparison
- Auto-completes matched stints by calling `complete_stint()` function
- If browser closed during stint, server still completes on time
- Paused stints are excluded; working time does not accumulate while paused

### Notification Handling

- Timer worker sends `postMessage({ completed: true })` at completion
- Main thread requests notification permission (if not granted)
- Shows browser notification: "Stint completed for [Project Name]! ðŸŽ‰"
- Clicking notification focuses LifeStint tab (if open) or opens new tab

---

## Data Validation & Constraints

### Client-Side Validation (Immediate Feedback)

```javascript
// Project name validation
const projectNameSchema = z.string()
  .min(1, "Name required")
  .max(100, "Name too long")
  .refine(name => !existingProjects.includes(name), "Name already exists");

// Stint duration validation
const stintDurationSchema = z.number()
  .int()
  .min(5, "Minimum 5 minutes")
  .max(480, "Maximum 480 minutes");

// Expected daily stints validation
const dailyStintsSchema = z.number()
  .int()
  .min(1, "At least 1 stint")
  .max(8, "Maximum 8 stints");
```

### Server-Side Validation (Authoritative)

- All PostgreSQL constraints enforced (see [05-database-schema.md](./05-database-schema.md))
- Database constraints and RLS policies validate all operations:
  - Project name uniqueness (case-insensitive) via unique constraint
  - Numeric ranges via CHECK constraints
  - Foreign key existence via FK constraints
  - Business rules (e.g., no active stint exists) via database functions

### Rate Limiting

```javascript
// Cloudflare rate limits (per user IP)
{
  '/api/stints/start': '60 per hour',    // Prevent stint spam
  '/api/projects': '100 per hour',        // CRUD operations
  '/api/auth/login': '10 per 15 min',    // Brute force protection
  '/api/auth/register': '5 per hour',    // Signup spam
  '/api/export/csv': '20 per hour'       // Export abuse
}

// Additional Supabase-level rate limits
{
  'read_operations': '1000 per minute',
  'write_operations': '200 per minute',
  'realtime_connections': '10 per user'
}
```

### Input Sanitization

- All text inputs sanitized with DOMPurify before rendering
- Markdown/HTML not supported (plain text only)
- SQL injection prevented by Supabase parameterized queries

---

## CSV Export Format

### File Naming

- Format: `LifeStint-Focus-Ledger-YYYY-MM-DD-to-YYYY-MM-DD.csv`
- Example: `LifeStint-Focus-Ledger-2025-10-17-to-2025-10-23.csv`

### CSV Structure

```csv
LifeStint Focus Ledger
User: Sarah Johnson (sarah@example.com)
Timezone: America/New_York
Export Date: 2025-10-24 14:30:00
Date Range: 2025-10-17 to 2025-10-23

Date,Project Name,Started At,Ended At,Planned Duration (min),Actual Duration (min),Pause Duration (min),Completion Type,Notes
2025-10-23,Client Website Redesign,2025-10-23 09:15:00,2025-10-23 10:05:00,50,50,0,auto,
2025-10-23,API Integration Project,2025-10-23 11:00:00,2025-10-23 11:45:00,50,45,5,manual,"Finished task early, documented API endpoints"
2025-10-23,Personal Learning,2025-10-23 14:30:00,2025-10-23 15:20:00,50,50,0,auto,
2025-10-22,Client Website Redesign,2025-10-22 09:00:00,2025-10-22 09:50:00,50,50,0,auto,
...

Summary
Total Stints: 14
Total Focus Time: 11 hours 30 minutes
Total Pause Time: 25 minutes
Completion Rate: 85.7% (12 completed, 2 interrupted)
Projects Worked On: 3
```

### Field Descriptions

- Timestamps in user's timezone (converted from UTC)
- Duration columns in minutes for readability
- Notes column includes user-entered text (escaped for CSV safety)
- Summary section at bottom for quick insights

### Generation Process

1. User clicks "Export CSV" button
2. Frontend queries stints in date range via Supabase client
3. Client converts timestamps to user's timezone
4. Generates CSV string in browser memory
5. Creates downloadable blob and triggers browser download
6. No server-side processing required (fully client-side)

### Professional Formatting

- Clean, readable layout
- Header with user context
- Summary statistics at bottom
- Client-ready (no internal IDs or technical jargon)

---

**Related Documents:**
- [04-technical-architecture.md](./04-technical-architecture.md) - Architecture context
- [05-database-schema.md](./05-database-schema.md) - Database schema reference
- [03-feature-requirements.md](./03-feature-requirements.md) - Feature requirements

# LifeStint - Development Roadmap

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## Phase 1: Foundation (Weeks 1-2)

**Goal:** Set up authentication, database, and development environment.

**Tasks:**
1. Initialize Nuxt 3 project with TypeScript
2. Configure Supabase project (production + staging)
3. Set up local Supabase development environment
4. Implement authentication:
   - Registration with email verification
   - Login/logout
   - Password recovery
   - Session persistence
5. Create database schema:
   - Users table with RLS
   - User preferences table
   - Implement utility functions (update_updated_at_column)
6. Set up CI/CD pipeline (GitHub Actions)
7. Configure Sentry for error tracking
8. Create basic UI shell (nav, layout, routing)

**Deliverable:** Working authentication flow, empty dashboard, database ready for projects.

**Dependencies:** None (foundational)

---

## Phase 2: Project Management (Weeks 3-4)

**Goal:** Enable project CRUD operations via dashboard modals.

**Tasks:**
1. Create projects table with RLS policies
2. Implement Project CRUD API (direct Supabase client with RLS):
   - Create project
   - Read projects (user's only)
   - Update project
   - Archive project (soft delete)
3. Build project modal component:
   - Form validation (Zod schema)
   - Color picker
   - Expected daily stints slider
   - Custom stint duration input (optional)
4. Implement activate/deactivate toggle
5. Build project card component:
   - Display project info
   - Edit/archive buttons
   - Activate/deactivate toggle
6. Add project list to dashboard:
   - Grid layout (responsive)
   - Active projects first, sorted by last stint time
   - "Inactive Projects" collapsible section
7. Handle edge cases:
   - Empty state (no projects)
   - Maximum projects limit (25 active)
   - Name uniqueness validation

**Deliverable:** Full project management via dashboard, no separate project page needed.

**Dependencies:** Phase 1 complete (auth + database)

**Testing:**
- Unit tests for validation logic
- Integration tests for CRUD operations
- E2E tests for modal workflows

---

## Phase 3: Stint Management Core (Weeks 5-7)

**Goal:** Implement start/stop/pause/resume with single active stint enforcement.

**Tasks:**
1. Create stints table with RLS policies
2. Create user_streaks table
3. Implement single active stint constraint:
   - Database function: `validate_stint_start()`
   - Check for existing active stints before insert
   - Return 409 Conflict if found
4. Build stint data layer (direct Supabase client):
   - `startStint()`: Create active stint via database insert
   - `pauseStint()`: Pause active stint via database update
   - `resumeStint()`: Resume paused stint via database update
   - `stopStint()`: Complete stint manually via database update
   - `getActiveStint()`: Get user's active stint via database query
5. Implement optimistic locking:
   - Add version field to users table
   - Increment on stint operations
   - Reject stale operations with 409
6. Build timer system:
   - Web Worker for countdown timer
   - Sync with server every 60 seconds
   - Handle background tab throttling
7. Update project card UI:
   - Show Start/Stop/Pause/Resume buttons based on state
   - Display countdown timer during active stint
   - Highlight active project card
8. Implement completion logic:
   - Manual stop with optional notes modal
   - Auto-complete when timer reaches 0
   - Browser notification on completion
9. Handle interruptions:
   - Network loss detection
   - Mark stint as interrupted
   - Preserve data for analytics
10. Real-time UI updates:
    - Supabase Realtime subscription to stints table
    - Broadcast stint events to all user's devices
    - Optimistic UI updates with rollback on conflict

**Deliverable:** Fully functional stint tracking with pause/resume, single session enforcement, and real-time sync.

**Dependencies:** Phase 2 complete (projects exist)

**Testing:**
- Unit tests for timer logic
- Integration tests for API endpoints
- E2E tests for complete stint workflow
- Load testing for race conditions (simultaneous starts)

---

## Phase 4: Timer System & Auto-Completion (Week 8)

**Goal:** Ensure timer accuracy and server-side auto-completion.

**Tasks:**
1. Implement Web Worker timer:
   - High-precision countdown using Date.now()
   - Survives background tabs
   - Communicates with main thread via postMessage
2. Build server-side auto-completion:
   - pg_cron job (runs every 30 seconds)
   - Query stints where `started_at + planned_duration <= now()` and `status = 'active'`
   - Call `complete_stint()` database function for matched stints
   - Broadcast completion event via Realtime
3. Implement timer sync:
   - Every 60 seconds, GET /api/stints/active
   - Compare local timer with server time
   - Correct drift if >5 seconds
4. Handle edge cases:
   - Browser closed during stint: Server auto-completes
   - Browser reopened after completion: Show completion UI retroactively
   - Clock changes (e.g., DST): Server-authoritative time prevents issues
5. Add browser notifications:
   - Request permission on first stint start
   - Show notification at completion
   - Clicking notification focuses LifeStint tab

**Deliverable:** Accurate, server-authoritative timer system with auto-completion.

**Dependencies:** Phase 3 complete (stint management)

**Testing:**
- Test timer accuracy in background tabs
- Test auto-completion when browser closed
- Test DST transitions
- Test notification delivery

---

## Phase 5: Dashboard Experience & Daily Reset (Weeks 9-10)

**Goal:** Polish dashboard with progress tracking and daily reset.

**Tasks:**
1. Implement daily progress calculation:
   - Count completed stints today
   - Compare to expected_daily_stints
   - Display as badge: "X of Y stints today"
2. Add visual progress bar to project cards
3. Implement streak counter:
   - Calculate on dashboard load
   - Display on project cards: "ðŸ”¥ 5 day streak"
   - Update in real-time when stint completed
4. Build daily reset logic:
   - pg_cron job (runs every hour)
   - Query users whose local midnight passed in last hour
   - Reset daily progress counters to 0
   - Trigger daily summary aggregation
   - Broadcast reset event via Realtime
5. Add celebration animations:
   - Confetti animation when daily goal reached
   - Celebration sound (optional, can disable)
   - Encouraging messages
6. Improve empty states:
   - No projects: Illustration + CTA
   - No stints today: Motivational quote
   - All projects inactive: Reminder to activate
7. Polish error handling:
   - Network offline banner
   - Server error retry button
   - Conflict resolution modal
8. Implement timezone selection:
   - Detect browser timezone on registration
   - Allow change in settings
   - Update daily reset calculations

**Deliverable:** Complete, polished dashboard with progress tracking and daily reset.

**Dependencies:** Phase 4 complete (timer system)

**Testing:**
- Test daily reset across timezones
- Test DST transitions
- Test celebration triggers
- E2E tests for complete daily workflow

---

## Phase 6: Offline Support (Week 11)

**Goal:** Enable offline stint tracking with smart sync.

**Tasks:**
1. Implement PWA manifest:
   - App icons (512x512, 192x192)
   - Splash screens
   - Display mode: standalone
   - Theme color
2. Build Service Worker:
   - Cache app shell (HTML, CSS, JS)
   - Cache static assets (fonts, icons)
   - Network-first strategy for API calls
   - Cache-first for static assets
3. Set up IndexedDB for offline queue:
   - Install Dexie.js
   - Create `offline_queue` table
   - Store pending operations with timestamps
4. Implement offline detection:
   - Listen to `navigator.onLine` events
   - Show offline banner when disconnected
   - Disable network-dependent features (projects CRUD, analytics)
5. Build sync manager:
   - Process queue on reconnect
   - Prioritize active stint sync
   - Handle server validation errors
   - Show sync progress UI
6. Implement conflict resolution:
   - Detect offline divergence
   - Show conflict resolution modal
   - Allow user to choose resolution strategy
7. Test offline scenarios:
   - Start stint offline, sync online
   - Stop stint offline, sync online
   - Concurrent device usage during offline period

**Deliverable:** PWA with offline stint tracking and intelligent sync.

**Dependencies:** Phase 5 complete (dashboard experience)

**Testing:**
- Test PWA installation on iOS/Android
- Test offline stint workflow
- Test sync with conflicts
- Test network reconnection handling

---

## Phase 7: Analytics & Export (Weeks 12-13)

**Goal:** Provide basic analytics and CSV export for professional reporting.

**Tasks:**
1. Create daily_summaries table
2. Implement aggregation function:
   - `aggregate_daily_summary()` SQL function
   - pg_cron job (runs at midnight user time)
   - Pre-calculate daily stats for performance
3. Build analytics page:
   - Daily summary section (today's stats)
   - Weekly summary section (7-day overview)
   - Simple bar chart (Chart.js)
   - Project breakdown list
4. Implement streak tracking:
   - `calculate_streak()` SQL function
   - Display current streak prominently
   - Show longest streak all-time
   - Grace period logic (1 day)
5. Build CSV export:
   - Client-side generation using Supabase queries
   - Query stints in date range via Supabase client
   - Convert timestamps to user timezone in browser
   - Generate CSV with header and summary
   - Trigger browser download
6. Add export UI:
   - Date range picker (presets + custom)
   - "Export CSV" button
   - Download triggers immediately
   - Show loading state during generation
7. Polish analytics UI:
   - Responsive design (mobile-friendly)
   - Loading skeletons
   - Empty state (no data yet)
8. Implement caching:
   - Cache daily summaries (5-minute TTL)
   - Invalidate cache on stint completion

**Deliverable:** Analytics page with CSV export for client reporting.

**Dependencies:** Phase 6 complete (offline support)

**Testing:**
- Test streak calculations across date ranges
- Test CSV export with various date ranges
- Test timezone conversions in export
- Test analytics performance with large datasets

---

## Phase 8: Settings & Preferences (Week 14)

**Goal:** Allow users to customize their experience.

**Tasks:**
1. Build settings page:
   - Account section (email, name)
   - Preferences section (default stint duration, theme, notifications)
   - Privacy section (data export, account deletion)
2. Implement preference updates:
   - Update user_preferences table
   - Apply changes immediately (no page refresh)
3. Add password change flow:
   - Current password verification
   - New password with confirmation
   - Email notification on change
4. Build data export feature:
   - Export all user data as JSON (GDPR compliance)
   - Include projects, stints, preferences
   - One-click download
5. Implement account deletion:
   - Confirmation modal with password
   - Soft delete (mark deleted, don't purge immediately)
   - Scheduled cleanup after 30 days
   - Email confirmation
6. Add theme switcher:
   - Light, Dark, System options
   - Persists in user_preferences
   - Applies immediately via CSS variables

**Deliverable:** Settings page with full preference control and GDPR compliance.

**Dependencies:** Phase 7 complete (analytics)

**Testing:**
- Test preference updates
- Test account deletion flow
- Test data export completeness
- Test theme switching

---

## Phase 9: Polish & Launch Prep (Weeks 15-16)

**Goal:** Final polish, performance optimization, and launch preparation.

**Tasks:**
1. Performance optimization:
   - Code splitting (lazy load routes)
   - Image optimization
   - Database query optimization (add indexes)
   - Bundle size reduction
   - Lighthouse audit (target: >90 on all metrics)
2. Accessibility audit:
   - WCAG 2.1 Level AA compliance check
   - Keyboard navigation testing
   - Screen reader testing (NVDA, VoiceOver)
   - Color contrast verification
   - Focus indicators on all interactive elements
3. Browser compatibility testing:
   - Chrome, Firefox, Safari, Edge (latest versions)
   - Mobile Safari, Mobile Chrome
   - Test on various screen sizes (320px to 2560px)
4. Security audit:
   - Penetration testing (basic)
   - RLS policy verification
   - Rate limiting testing
   - XSS prevention verification
   - CSRF protection testing
5. Documentation:
   - User guide (in-app help center)
   - Developer documentation (API reference)
   - Deployment guide
   - Troubleshooting guide
6. Marketing site:
   - Landing page with demo video
   - Pricing page (Free vs Pro)
   - FAQ page
   - Terms of Service, Privacy Policy
7. Analytics setup:
   - Implement Mixpanel events
   - Set up funnels and cohorts
   - Define key metrics dashboard
8. Launch checklist:
   - DNS setup (lifestint.com)
   - SSL certificates
   - Error monitoring (Sentry)
   - Uptime monitoring (BetterUptime)
   - Backup verification
   - Rollback plan

**Deliverable:** Production-ready application with all polish and monitoring in place.

**Dependencies:** Phase 8 complete (settings)

**Testing:**
- Full regression testing
- Performance benchmarking
- Security scan (OWASP ZAP)
- Load testing (simulate 100 concurrent users)

---

## Phase 10: Beta Launch & Iteration (Weeks 17-20)

**Goal:** Soft launch with early adopters, gather feedback, iterate.

**Tasks:**
1. Private beta invites:
   - Invite 50-100 consultants/freelancers
   - Onboarding email with guide
   - Set up feedback channel (email + Discord)
2. Monitoring & support:
   - Daily Sentry error review
   - Weekly feedback review
   - User interviews (5-10 users)
3. Iteration based on feedback:
   - Bug fixes (prioritize blockers)
   - UI/UX improvements
   - Performance optimizations
4. Feature additions (based on demand):
   - Tags/categories (if requested)
   - Weekly goals
   - Calendar integration
5. Prepare for public launch:
   - Press kit
   - Product Hunt launch
   - Social media content

**Deliverable:** Validated MVP with real users, ready for public launch.

**Dependencies:** Phase 9 complete (launch prep)

**Success Metrics:**
- 7-day retention: >40%
- Daily active users: >30% of signups
- Average stints per user per week: >5
- CSV exports per month: >20% of users

---

## Post-MVP Roadmap (Future Phases)

### Phase 11: Advanced Analytics
- Weekly/monthly trends
- Project comparison charts
- Time of day productivity analysis
- Export to PDF with charts

### Phase 12: Collaboration Features
- Shared projects (team stints)
- Team analytics dashboard
- Admin role for project managers

### Phase 13: Integrations
- Calendar sync (Google Calendar, Outlook)
- Slack notifications
- Zapier integration
- Time tracking tool import (Toggl, Harvest)

### Phase 14: Mobile Apps
- React Native app (iOS + Android)
- Native notifications
- Offline-first architecture
- Widget for home screen

### Phase 15: Enterprise Features
- SSO (SAML, OAuth)
- Custom branding
- Advanced permissions
- Audit logs (user-facing)
- SLA guarantees

---

**Related Documents:**
- [03-feature-requirements.md](./03-feature-requirements.md) - Feature specifications
- [04-technical-architecture.md](./04-technical-architecture.md) - Technical architecture
- [08-success-metrics.md](./08-success-metrics.md) - Success metrics for each phase

# LifeStint - Success Metrics & Analytics

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## MVP Success Criteria (First 3 Months)

### User Acquisition

- 500 registered users
- 200 weekly active users (WAU)
- 30% conversion from landing page to signup

### Engagement

- 7-day retention: >40%
- 30-day retention: >25%
- Average stints per user per week: >5
- Average session duration: >25 minutes
- Stint completion rate: >80% (not interrupted)

### Product Validation

- CSV export usage: >20% of active users monthly
- Streak maintenance: >30% of users with 5+ day streak
- Average projects per user: 3-4
- Mobile usage: >40% of sessions

### Business Metrics

- Free to Pro conversion: >5% (post-MVP with paid tier)
- Churn rate: <10% monthly
- NPS (Net Promoter Score): >40

### Technical Health

- Uptime: >99.5%
- API response time (p95): <500ms
- Dashboard load time: <2 seconds
- Error rate: <0.1% of requests

---

## Key Performance Indicators (KPIs)

### North Star Metric

**Weekly focused minutes per user**
- Target: 300+ minutes (2.5+ stints at 120 min each)
- Why: Directly measures core value proposition (focused work)
- Tracking: Sum of `actual_duration` for completed stints per user per week

### Supporting Metrics

#### Usage

- **Daily active users (DAU) / Monthly active users (MAU) ratio**
  - Target: >0.3 (30% of monthly users active daily)
  - Indicates habit formation

- **Average stints per user per day**
  - Target: >1.5 stints/day
  - Measures consistent usage

- **Stint completion rate (not interrupted)**
  - Target: >80%
  - Measures focus quality

- **Pause frequency (lower is better)**
  - Target: <20% of stints paused
  - Indicates uninterrupted focus

#### Retention

- **D1 retention (return next day)**
  - Target: >50%
  - Early indicator of product-market fit

- **D7 retention (return within 7 days)**
  - Target: >40%
  - Key milestone for habit formation

- **D30 retention (return within 30 days)**
  - Target: >25%
  - Long-term engagement indicator

- **Cohort retention curves**
  - Track retention by signup week
  - Identify trends and improvements

#### Quality

- **Average actual stint duration vs planned**
  - Target: 85-100% of planned duration
  - Measures timer accuracy and user commitment

- **Projects with daily goals met**
  - Target: >60% of active projects meet daily goals
  - Measures goal achievement

- **Streak length distribution**
  - Track: % users with 1+, 7+, 14+, 30+ day streaks
  - Measures habit strength

- **CSV export frequency**
  - Target: >20% of active users export monthly
  - Validates professional reporting value

#### Monetization (Post-MVP)

- **Free to Pro conversion rate**
  - Target: >5%
  - Measures willingness to pay

- **Monthly recurring revenue (MRR)**
  - Target: $5K MRR by month 6
  - Business sustainability metric

- **Average revenue per user (ARPU)**
  - Target: $10/month (40% free, 60% Pro)
  - Revenue efficiency

- **Customer lifetime value (CLV)**
  - Target: $240 (24-month avg retention)
  - Long-term value

- **Churn rate**
  - Target: <10% monthly
  - Retention indicator

---

## Analytics Events

### User Lifecycle

**user_registered**
- Properties: `email`, `registration_source`, `timezone`
- When: User completes registration form
- Purpose: Track signup funnel

**email_verified**
- Properties: `time_to_verification` (seconds)
- When: User clicks verification link
- Purpose: Measure verification friction

**onboarding_completed**
- Properties: `time_to_first_stint` (seconds), `projects_created`
- When: User completes first stint
- Purpose: Measure onboarding success

### Project Events

**project_created**
- Properties: `project_id`, `expected_daily_stints`, `custom_duration`, `has_color_tag`
- When: User creates new project
- Purpose: Track project setup patterns

**project_edited**
- Properties: `project_id`, `changed_fields` (array)
- When: User updates project
- Purpose: Measure feature usage

**project_activated**
- Properties: `project_id`
- When: User activates inactive project
- Purpose: Track project lifecycle

**project_deactivated**
- Properties: `project_id`
- When: User deactivates project
- Purpose: Track project lifecycle

**project_archived**
- Properties: `project_id`, `stint_count`, `days_active`
- When: User archives project
- Purpose: Measure project completion patterns

### Stint Events

**stint_started**
- Properties: `project_id`, `planned_duration`, `device_type`, `is_custom_duration`
- When: User starts a stint
- Purpose: Core usage tracking

**stint_paused**
- Properties: `project_id`, `time_elapsed` (seconds), `pause_count`
- When: User pauses active stint
- Purpose: Measure interruption patterns

**stint_resumed**
- Properties: `project_id`, `pause_duration` (seconds)
- When: User resumes paused stint
- Purpose: Measure interruption patterns

**stint_stopped_manual**
- Properties: `project_id`, `actual_duration` (seconds), `has_notes`, `completion_percentage`
- When: User manually stops stint
- Purpose: Measure completion patterns

**stint_auto_completed**
- Properties: `project_id`, `actual_duration` (seconds)
- When: Stint auto-completes at planned end time
- Purpose: Measure completion patterns

**stint_interrupted**
- Properties: `project_id`, `reason`, `time_elapsed` (seconds)
- When: Stint marked as interrupted
- Purpose: Track failure modes

### Analytics Events

**analytics_viewed**
- Properties: `page` (daily/weekly), `date_range`
- When: User views analytics page
- Purpose: Measure feature usage

**csv_exported**
- Properties: `date_range`, `stint_count`, `projects_count`
- When: User exports CSV
- Purpose: Validate professional reporting value

**streak_reached**
- Properties: `streak_length`, `milestone` (7/14/30 days)
- When: User reaches streak milestone
- Purpose: Measure habit formation

### Settings Events

**preferences_updated**
- Properties: `changed_fields` (array)
- When: User updates preferences
- Purpose: Track customization usage

**theme_changed**
- Properties: `new_theme`
- When: User changes theme
- Purpose: Track feature usage

**password_changed**
- Properties: `success`
- When: User changes password
- Purpose: Security tracking

**account_deleted**
- Properties: `reason` (optional)
- When: User deletes account
- Purpose: Churn analysis

---

## Tracking Implementation

### Event Tracking Library

- **Mixpanel** (post-MVP)
  - User event tracking
  - Funnel analysis
  - Cohort analysis
  - A/B test tracking

### Event Structure

```typescript
interface AnalyticsEvent {
  event: string;
  properties: Record<string, any>;
  userId: string;
  timestamp: number;
  sessionId: string;
}
```

### Privacy Considerations

- No PII in event properties (use hashed IDs)
- Opt-out mechanism for analytics
- GDPR-compliant data handling
- Event data retention: 25 months (Mixpanel default)

---

## Dashboard Metrics

### Product Dashboard (Weekly Review)

**Acquisition:**
- New signups (week over week)
- Signup sources breakdown
- Conversion rate (landing â†’ signup)

**Engagement:**
- DAU/MAU ratio
- Average stints per user
- Stint completion rate
- Streak distribution

**Retention:**
- D1, D7, D30 retention rates
- Cohort retention curves
- Churn rate

**Feature Usage:**
- CSV export frequency
- Analytics page views
- Project creation rate
- Settings customization rate

### Technical Dashboard (Daily Review)

**Performance:**
- API response time (p50, p95, p99)
- Dashboard load time
- Real-time sync latency
- Timer drift measurement

**Reliability:**
- Uptime percentage
- Error rate
- Failed API calls
- WebSocket disconnections

**Usage:**
- API calls per minute
- Database query performance
- pg_cron job execution time
- Storage usage

---

**Related Documents:**
- [01-product-overview-strategy.md](./01-product-overview-strategy.md) - Business goals and strategy
- [07-development-roadmap.md](./07-development-roadmap.md) - Phase-specific success criteria
- [09-operations-compliance.md](./09-operations-compliance.md) - Monitoring and alerting

# LifeStint - Operations, Security & Compliance

**Product Name:** LifeStint  
**Document Version:** 4.0
**Date:** December 2, 2025

---

## Risks and Mitigations

### Technical Risks

**Risk 1: Real-Time Sync Latency**
- **Impact:** High. Poor sync experience damages core value prop.
- **Probability:** Medium. WebSocket connections can be unstable.
- **Mitigation:**
  - Implement fallback polling (every 5 seconds) if WebSocket disconnects
  - Use optimistic UI updates (immediate feedback, rollback if server rejects)
  - Server-authoritative time for all operations
  - Test on slow networks (3G simulation)
- **Contingency:** If real-time sync unreliable, revert to manual refresh button with warning banner.

**Risk 2: Timer Accuracy in Background Tabs**
- **Impact:** High. Inaccurate timers undermine trust.
- **Probability:** High. Browser throttling is expected behavior.
- **Mitigation:**
  - Use Web Workers (not affected by throttling)
  - Server-side auto-completion (fallback if browser closed)
  - Sync with server every 60 seconds
  - Server time is authoritative (client cannot manipulate)
- **Contingency:** If Web Worker fails, show warning: "Keep this tab active for accurate timing."

**Risk 3: Offline Sync Conflicts**
- **Impact:** Medium. Data loss or confusion damages trust.
- **Probability:** Medium. Users will work offline occasionally.
- **Mitigation:**
  - Clear conflict resolution UI (user chooses resolution)
  - Server-side validation prevents data corruption
  - Mark conflicted stints as "interrupted" (preserves data)
  - IndexedDB for persistent offline queue
- **Contingency:** If conflicts too complex, disable offline stint tracking (only allow viewing cached data offline).

**Risk 4: Database Performance at Scale**
- **Impact:** High. Slow queries damage UX.
- **Probability:** Low in MVP (small user base), High at scale.
- **Mitigation:**
  - Pre-aggregate daily summaries (avoid heavy SUM queries)
  - Strategic indexes on query-heavy columns
  - Query optimization (EXPLAIN ANALYZE)
  - Caching layer (5-minute TTL for analytics)
- **Contingency:** If database slow, implement read replicas or migrate to Timescale (time-series optimized PostgreSQL).

**Risk 5: Supabase Vendor Lock-In**
- **Impact:** Medium. Difficult to migrate if needed.
- **Probability:** Low. Supabase is PostgreSQL-based (standard).
- **Mitigation:**
  - Use standard PostgreSQL features (pg_cron, PL/pgSQL functions)
  - Direct client model avoids serverless vendor lock-in
  - All data exportable as SQL dump
- **Contingency:** Migration path to self-hosted PostgreSQL + Auth0 documented.

### Product Risks

**Risk 6: Feature Creep (Building Too Much)**
- **Impact:** High. Delayed launch, bloated product.
- **Probability:** High. Consultants will request many features.
- **Mitigation:**
  - Strict MVP scope (this PRD)
  - "No" is default answer to new feature requests
  - Validate with 5+ users before adding features
  - Track feature request votes (build most-wanted only)
- **Contingency:** Regular scope reviews, ruthless prioritization.

**Risk 7: Insufficient User Adoption**
- **Impact:** High. Product doesn't reach critical mass.
- **Probability:** Medium. Productivity tool market is crowded.
- **Mitigation:**
  - Private beta with warm introductions (not cold launch)
  - Referral program (invite friends, earn Pro tier)
  - Content marketing (blog posts on focus techniques)
  - Product Hunt launch with demo video
- **Contingency:** Pivot focus: Target agencies/teams instead of individuals (easier sales motion).

**Risk 8: Pricing Model Rejection**
- **Impact:** Medium. No revenue despite usage.
- **Probability:** Medium. Users may expect free forever.
- **Mitigation:**
  - Free tier generous (2 projects, 90-day analytics)
  - Pro tier clear value (unlimited projects, custom branding)
  - Transparent pricing from day 1 (no bait-and-switch)
  - Annual discount (save 20%)
- **Contingency:** If conversions low, test different price points ($8, $12, $15/month).

**Risk 9: Competition from Established Players**
- **Impact:** Medium. Users stick with known tools.
- **Probability:** Medium. Toggl/Harvest could copy stint approach.
- **Mitigation:**
  - Focus on niche (consultants, not all knowledge workers)
  - Emphasize professional reporting (not just tracking)
  - Build community (Discord, newsletter)
  - Fast iteration (ship weekly updates)
- **Contingency:** If outcompeted, explore acquisition by larger player or pivot to B2B.

### Business Risks

**Risk 10: Regulatory Compliance (GDPR, CCPA)**
- **Impact:** High. Fines and legal issues.
- **Probability:** Low. We don't collect much PII.
- **Mitigation:**
  - GDPR compliance from day 1 (data export, deletion)
  - Privacy policy reviewed by lawyer
  - Cookie consent banner
  - No data sold to third parties
- **Contingency:** If regulation changes, hire compliance consultant.

**Risk 11: Customer Support Overload**
- **Impact:** Medium. Poor support damages reputation.
- **Probability:** Medium. Users will have questions.
- **Mitigation:**
  - Comprehensive help center (Intercom or similar)
  - In-app tooltips and onboarding
  - Email support with 24-hour SLA
  - User community (Discord) for peer support
- **Contingency:** If support volume high, hire part-time support agent.

**Risk 12: Financial Runway**
- **Impact:** High. Run out of money before product-market fit.
- **Probability:** Medium. SaaS typically takes 12-24 months.
- **Mitigation:**
  - Bootstrap (low burn rate, founder does all work)
  - Supabase free tier ($0 until 50K MAU)
  - No paid marketing initially (organic + referrals)
  - Target 3-month MVP launch (minimize time to revenue)
- **Contingency:** If runway low, offer consulting services to fund development.

---

## Monitoring Alerts

### Auto-Completion Monitoring

**Critical Metric:** Auto-completion success rate

Monitor the auto-completion cron job to ensure stints are being completed automatically:

```sql
-- Check recent auto-completions (last 24 hours)
SELECT
  DATE_TRUNC('hour', ended_at) as hour,
  COUNT(*) as auto_completed_stints
FROM stints
WHERE completion_type = 'auto'
  AND ended_at > now() - interval '24 hours'
GROUP BY hour
ORDER BY hour DESC;
```

```sql
-- Verify cron job is scheduled and active
SELECT jobname, schedule, active, last_run_time, last_run_status
FROM cron.job
JOIN cron.job_run_details ON job.jobid = job_run_details.jobid
WHERE jobname = 'auto-complete-stints'
ORDER BY last_run_time DESC
LIMIT 1;
```

```sql
-- Check cron execution history (last 10 runs)
SELECT
  runid,
  status,
  return_message,
  start_time,
  end_time,
  end_time - start_time as duration
FROM cron.job_run_details
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'auto-complete-stints')
ORDER BY start_time DESC
LIMIT 10;
```

**Alerts:**
- **No auto-completions for >10 minutes** (when stints should be expiring) â†’ Cron job failure (CRITICAL)
- **Auto-completion error rate >5%** â†’ Investigate function errors
- **Stints >1 hour overdue** â†’ Cron job not running
- **Cron job execution time >1 second** â†’ Performance degradation

**GitHub Actions Monitoring** (if using Option 1):
- Check workflow runs: https://github.com/{owner}/{repo}/actions/workflows/auto-complete-stints.yml
- Set up notifications for workflow failures in repository settings

### Sentry Alerts (Slack notifications)

- **>10 errors in 5 minutes** â†’ Critical
- **>50 errors in 1 hour** â†’ Warning
- **New error type (first occurrence)** â†’ Info
- **Error rate increase >50% vs previous hour** â†’ Warning

### Uptime Alerts (BetterUptime, future)

- **API endpoint down (2 consecutive failures)** â†’ Critical
- **Response time >2 seconds (p95)** â†’ Warning
- **SSL certificate expiring in 30 days** â†’ Info

### Database Alerts (Supabase, built-in)

- **Connection pool >80% utilization** â†’ Warning
- **Disk usage >80%** â†’ Warning
- **Query time >5 seconds** â†’ Warning
- **Replication lag >1 minute** â†’ Critical

### Custom Alerts (pg_cron Monitoring)

- **Active stints >1 hour overdue for completion** â†’ Warning (pg_cron may be failing)
- **Daily reset not triggered for user in 25 hours** â†’ Critical
- **pg_cron job execution failures** â†’ Warning

---

## Data Retention Policy

### User Data

- **Active accounts:** Retained indefinitely
- **Deleted accounts:** 30-day soft delete, then purged
- **Inactive accounts (no login >2 years):** Notified at 18 months, deleted at 24 months

### Stint History

- **Free tier:** 90 days
- **Pro tier:** Unlimited retention
- **After account deletion:** Purged after 30 days

### Analytics Data

- **Mixpanel events:** 25 months retention (Mixpanel default)
- **Daily summaries:** Unlimited retention (small data size)

### Logs

- **Supabase logs:** 7 days (free tier), 30 days (Pro project)
- **Sentry events:** 90 days
- **Audit logs:** 90 days, then archived to S3 (future)

### Backups

- **Daily database backups:** 7 days retention
- **Weekly backups:** 30 days retention
- **Monthly backups:** 1 year retention (future)

---

## GDPR Compliance Checklist

### User Rights

âœ… **Right to access:** Data export via settings  
âœ… **Right to rectification:** Users can edit their data  
âœ… **Right to erasure:** Account deletion available  
âœ… **Right to data portability:** CSV and JSON exports  
âœ… **Right to object:** Opt-out of analytics/emails

### Privacy by Design

âœ… **Minimal data collection:** Only email, name, timezone  
âœ… **No PII in logs:** Logs sanitized before storage  
âœ… **Encryption at rest and in transit:** AWS KMS + TLS 1.3  
âœ… **RLS enforces data isolation:** Database-level security

### Transparency

âœ… **Privacy policy:** Clearly explains data usage  
âœ… **Cookie consent banner:** For analytics cookies  
âœ… **No data sold to third parties:** Explicitly stated

### Data Protection

âœ… **Supabase GDPR-compliant:** EU data centers available  
âœ… **Data Processing Agreement (DPA):** With Supabase  
âœ… **Regular security audits:** Annual review

---

## Browser Compatibility Matrix

| Feature | Chrome 90+ | Firefox 88+ | Safari 14+ | Edge 90+ | Mobile Safari | Mobile Chrome |
|---------|-----------|-------------|------------|----------|---------------|---------------|
| Dashboard | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Stint Tracking | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Web Workers | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Notifications | âœ… | âœ… | âš ï¸ Requires permission | âœ… | âš ï¸ Limited | âœ… |
| PWA Install | âœ… | âš ï¸ Via browser | âœ… | âœ… | âœ… | âœ… |
| Offline Mode | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Real-time Sync | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |

**Notes:**
- Safari notification support requires user gesture (can't request on page load)
- Firefox PWA install via "Add to Home Screen" (not automatic prompt)
- All features require JavaScript enabled

---

## API Rate Limiting Details

### Cloudflare Rate Limits (per IP)

```
/api/stints/start â†’ 60 per hour
/api/stints/*/pause â†’ 120 per hour
/api/stints/*/resume â†’ 120 per hour
/api/stints/*/stop â†’ 120 per hour
/api/projects â†’ 100 per hour (CRUD)
/api/auth/login â†’ 10 per 15 minutes
/api/auth/register â†’ 5 per hour
/api/auth/reset-password â†’ 3 per hour
/api/export/csv â†’ 20 per hour
```

### Supabase Rate Limits (per user)

```
Database reads â†’ 1000 per minute
Database writes â†’ 200 per minute
Realtime connections â†’ 10 per user
Realtime messages â†’ 100 per second
Storage uploads â†’ 100 per hour
```

### 429 Response Format

```json
{
  "error": "Rate limit exceeded",
  "message": "Too many requests. Try again in 45 seconds.",
  "retry_after": 45,
  "limit": 60,
  "remaining": 0
}
```

### Client-Side Handling

- Show toast notification: "Too many requests. Please wait."
- Disable action button for `retry_after` seconds
- Exponential backoff for retries (1s, 2s, 4s)

---

## Database Migration Strategy

### Migration Tool

**Supabase Migrations** (SQL files in `/supabase/migrations`)

### Migration Process

1. Develop schema changes in migration files
2. Generate migration file: `supabase migration new <name>`
3. Test migration in local database: `supabase db reset`
4. Verify migration success (check tables, indexes, RLS policies)
5. Regenerate TypeScript types: `npm run supabase:types`

### Rollback Plan

- Each migration includes `-- REVERT` section
- For local development: `supabase db reset` restores to clean state
- Migration files versioned in Git for rollback history

### Zero-Downtime Migrations

- Additive changes (new columns) deployed first
- Deploy application code that works with old & new schema
- Run data migration (if needed)
- Deploy application code that requires new schema
- Remove old columns (if applicable)

---

## Glossary

**Stint:** A predetermined focused work session on a single project, typically 120 minutes.

**Active Stint:** A stint currently in progress (timer running).

**Paused Stint:** A stint temporarily paused by the user.

**Completed Stint:** A stint that finished (manually stopped or auto-completed).

**Interrupted Stint:** A stint that didn't complete normally (network issue, conflict, etc.). Doesn't count toward daily progress.

**Focus Ledger:** CSV export of stint history, formatted for professional client reporting.

**Daily Progress:** Number of completed stints today vs expected daily stints (e.g., "2 of 3").

**Streak:** Consecutive days with at least one completed stint.

**Grace Period:** 1-day allowance for streaks (can miss 1 day without breaking).

**Real-Time Sync:** Automatic synchronization of stint state across all user's connected devices.

**Optimistic Locking:** Concurrency control technique using version numbers to prevent race conditions.

**Row Level Security (RLS):** Database-level access control that enforces user data isolation.

**pg_cron:** PostgreSQL extension for scheduling database jobs, used for auto-completion and daily aggregation.

**Service Worker:** Browser background script enabling PWA features (offline support, notifications).

**Web Worker:** Browser background thread for running computationally intensive tasks (timer) without blocking UI.

---

**Related Documents:**
- [04-technical-architecture.md](./04-technical-architecture.md) - Infrastructure details
- [05-database-schema.md](./05-database-schema.md) - Database structure
- [08-success-metrics.md](./08-success-metrics.md) - Success metrics and monitoring
