# Implementation Plan: Daily Reset Logic

**Branch**: `005-daily-reset` | **Date**: 2025-12-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-daily-reset/spec.md`

## Summary

Implement a timezone-aware daily reset system that runs hourly via pg_cron, detecting when each user's local midnight has passed. The reset process aggregates the previous day's stints into a `daily_summaries` record with per-project breakdown (JSONB), and updates streak information. Daily progress counters are calculated dynamically from stints—not stored—so no explicit "reset" of counters is needed. Real-time dashboard updates are deferred to future work; users will see reset state on next page load.

## Technical Context

**Language/Version**: TypeScript 5.9.3 with Vue 3.5.24 Composition API + Nuxt 4.2.1 (SSG)
**Primary Dependencies**: @nuxtjs/supabase 1.6.2, @supabase/supabase-js 2.57.4, @tanstack/vue-query 5.90.6, Zod
**Storage**: PostgreSQL via Supabase with Row Level Security (RLS), local development via Docker
**Testing**: Vitest 3.2.4 with Happy DOM, co-located tests alongside source files
**Target Platform**: Static site (Vercel) + Supabase hosted PostgreSQL
**Project Type**: Web application (SSG frontend + PostgreSQL backend with pg_cron)
**Performance Goals**: SC-003 requires analytics page loads < 2 seconds regardless of history size
**Constraints**: Hourly cron job must process all timezone boundaries; zero duplicate summaries (unique user+date)
**Scale/Scope**: ~10k users across all IANA timezones; each user gets one daily_summary per day

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Three-Layer Data Architecture | ✅ PASS | New `daily_summaries` follows pattern: DB layer (`app/lib/supabase/daily-summaries.ts`), Schema layer (`app/schemas/daily-summaries.ts`), Composable layer (`app/composables/useDailySummaries.ts`) |
| II. Test-Driven Development | ✅ PASS | Co-located tests for all new functions; database mocking for unit tests, real DB for integration |
| III. SSG + Client-Side Auth | ✅ PASS | No changes to SSG architecture; cron runs server-side in PostgreSQL |
| IV. Type Safety & Code Generation | ✅ PASS | `npm run supabase:types` after migration; typed helpers for `daily_summaries` |
| V. User-Friendly Error Handling | ✅ PASS | Three-layer error propagation maintained |
| VI. Optimistic Updates | ⚪ N/A | `daily_summaries` is read-only for users; generated by cron |
| VII. Query Key Factory Pattern | ✅ PASS | Add `dailySummaryKeys` factory for cache management |

**Pre-Design Gate Status: ✅ PASSED** - All applicable principles will be followed.

## Project Structure

### Documentation (this feature)

```text
specs/005-daily-reset/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (database function signatures)
└── tasks.md             # Phase 2 output (created by /speckit.tasks)
```

### Source Code (repository root)

```text
app/
├── lib/supabase/
│   ├── daily-summaries.ts        # Database layer for daily_summaries
│   └── daily-summaries.test.ts   # Co-located tests
├── schemas/
│   ├── daily-summaries.ts        # Zod schema for daily summaries
│   └── daily-summaries.test.ts   # Co-located tests
├── composables/
│   ├── useDailySummaries.ts      # TanStack Query hooks
│   └── useDailySummaries.test.ts # Co-located tests
└── types/
    └── database.types.ts         # Auto-generated (updated)

supabase/migrations/
├── 20251216XXXXXX_create_daily_summaries_table.sql
├── 20251216XXXXXX_create_daily_reset_function.sql
└── 20251216XXXXXX_schedule_daily_reset_cron.sql
```

**Structure Decision**: Follows existing project conventions. New `daily_summaries` table with supporting functions. Cron job follows same pattern as existing `auto_complete_expired_stints`.

## Complexity Tracking

> No violations requiring justification. Implementation follows established patterns.

| Aspect | Approach | Rationale |
|--------|----------|-----------|
| Daily progress counters | Dynamic calculation from stints | Per spec: "calculated dynamically, not stored" |
| Daily summaries | Pre-aggregated JSONB | Per spec: enables fast analytics loading |
| Cron timing | Hourly at :00 | Catches all timezone boundaries within 1 hour |
| Real-time updates | Deferred | Per spec clarification: users see reset on next page load |
